<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Reject Remark</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-md mx-auto p-5 min-h-screen">
    <div class="bg-white rounded-3xl shadow p-6">
      <h1 class="text-xl font-extrabold">Reject Remark ❌</h1>
      <p class="text-sm text-slate-500 font-semibold mt-1">กรุณากรอกเหตุผลการไม่อนุมัติ (บังคับ)</p>

      <div class="mt-5">
        <label class="text-sm font-extrabold text-slate-700">Remark <span class="text-red-500">*</span></label>
        <textarea id="remark" rows="5" class="mt-2 w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10" placeholder="Type your reason..."></textarea>
      </div>

      <button id="btn" onclick="submitRemark()" class="mt-5 w-full bg-red-500 hover:bg-red-600 text-white font-extrabold py-3.5 rounded-2xl shadow active:scale-[0.98] transition">
        Submit Remark
      </button>

      <div id="msg" class="mt-4 text-sm font-semibold text-slate-600"></div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008997153-NcbVCWqs";
  const API_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec";

  let actor = null;
  let requestId = "";

  function $(id){ return document.getElementById(id); }

  async function apiPost(action, payloadObj) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" }, // ✅ avoid OPTIONS
      body: JSON.stringify({ action, ...payloadObj })
    });
    return await res.json();
  }

  async function init(){
    const params = new URLSearchParams(location.search);
    requestId = params.get("requestId") || "";
    if (!requestId) $("msg").textContent = "Missing requestId";

    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    actor = await liff.getProfile();
  }

  async function submitRemark(){
    const remark = $("remark").value.trim();
    if (!remark) { alert("Remark is required"); return; }
    if (!requestId) { alert("Missing requestId"); return; }

    $("btn").disabled = true;
    $("btn").classList.add("opacity-70");
    $("msg").textContent = "Submitting...";

    try {
      const data = await apiPost("reject_with_remark", {
        requestId,
        actorUserId: actor?.userId || "",
        remark
      });

      if (!data || !data.ok) throw new Error(data?.error || "reject_failed");

      $("msg").textContent = "Saved. You can close this window.";
      setTimeout(() => { try { liff.closeWindow(); } catch(e) {} }, 600);

    } catch(err) {
      $("btn").disabled = false;
      $("btn").classList.remove("opacity-70");
      $("msg").textContent = "Error: " + (err.message || err);
      alert(err.message || err);
    }
  }

  init().catch(err => alert("LIFF init error: " + (err.message || err)));
</script>
</body>
</html>
