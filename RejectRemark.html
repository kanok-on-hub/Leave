<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>Reject Remark</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <div class="max-w-md mx-auto p-5">
    <div class="bg-white rounded-2xl p-5 shadow space-y-4">
      <div class="text-xl font-extrabold text-slate-800">Reject Remark</div>
      <div class="text-sm text-slate-500">กรุณากรอกเหตุผลการไม่อนุมัติ (บังคับกรอก)</div>

      <textarea id="remark" rows="5" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" placeholder="พิมพ์เหตุผล..."></textarea>

      <button id="btn" class="w-full bg-red-500 text-white font-bold py-4 rounded-2xl shadow" onclick="submitRemark()">
        Confirm Reject
      </button>

      <div id="msg" class="text-xs text-slate-500 text-center"></div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008997153-NcbVCWqs";
  const API_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec";

  let profile=null;
  const $=(id)=>document.getElementById(id);

  function q(name){
    const u=new URL(location.href);
    return u.searchParams.get(name)||"";
  }

  async function submitRemark(){
    const requestId = q("requestId");
    const remark = $("remark").value.trim();
    if(!remark) return alert("Please fill remark");

    $("btn").disabled=true;
    $("btn").textContent="Submitting...";
    $("msg").textContent="Saving...";

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          action:"reject_remark",
          requestId,
          approverUserId: profile?.userId || "",
          remark
        })
      });
      const data = await res.json();
      if(!data || !data.ok) throw new Error(data?.error || "reject_failed");

      $("msg").textContent="Saved ✅";
      setTimeout(()=>liff.closeWindow(), 600);
    }catch(e){
      console.error(e);
      alert("Failed: " + (e.message||e));
      $("btn").disabled=false;
      $("btn").textContent="Confirm Reject";
      $("msg").textContent="";
    }
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    profile = await liff.getProfile();
  }

  init().catch(err=>{
    console.error(err);
    alert("LIFF init error: " + (err.message||err));
  });
</script>
</body>
</html>
