<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Reject Remark</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Plus Jakarta Sans',sans-serif; background:#f0f4f8; color:#1e293b; -webkit-tap-highlight-color:transparent; }
    ::-webkit-scrollbar { width:0; background:transparent; }
    .card { background:#fff; border-radius:1.25rem; box-shadow:0 4px 20px -2px rgba(226,232,240,.6); border:1px solid #f1f5f9; padding:1.25rem; }
    .input{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:.75rem; padding:.875rem; width:100%; outline:none; transition:.2s; font-size:.95rem; color:#334155; }
    .input:focus{ background:#fff; border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.1); }
    .err{ border-color:#ef4444!important; background:#fef2f2!important; box-shadow:0 0 0 4px rgba(239,68,68,.1)!important; }
    .info-badge{ font-size:11px; font-weight:700; background:#eff6ff; color:#2563eb; padding:4px 12px; border-radius:9999px; border:1px solid #dbeafe; box-shadow:0 1px 2px rgba(0,0,0,.05); display:inline-flex; align-items:center; white-space:nowrap;}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .shake-anim{ animation:shake .4s ease-in-out; }
  </style>
</head>

<body class="pb-32">
  <div class="max-w-md mx-auto min-h-screen flex flex-col">
    <!-- Header (tone same as index.html) -->
    <div class="bg-white px-6 pt-12 pb-8 rounded-b-[2.5rem] shadow-[0_10px_40px_-10px_rgba(0,0,0,0.05)] mb-6 relative z-10">
      <div class="flex items-center gap-4">
        <div id="avatarBox" class="w-14 h-14 rounded-full overflow-hidden border-2 border-white shadow-lg ring-2 ring-blue-50 hidden">
          <img id="profileImg" src="" class="w-full h-full object-cover">
        </div>
        <div class="flex-1">
          <div class="flex items-center justify-between gap-3">
            <h1 id="title" class="text-2xl font-bold text-slate-800 tracking-tight">Reject Remark ✍️</h1>
            <span class="info-badge">Approver</span>
          </div>
          <p id="userGreet" class="text-slate-500 text-sm font-medium mt-0.5 flex items-center gap-1">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Loading...
          </p>
        </div>
      </div>
    </div>

    <div class="px-5 space-y-6 flex-1">
      <!-- Summary (optional) -->
      <div class="card">
        <div class="flex items-center justify-between border-b border-slate-100 pb-3 mb-3">
          <div class="text-sm font-bold text-slate-700">Request Summary</div>
          <div id="reqIdBadge" class="text-[11px] font-bold text-slate-400">ID: -</div>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between gap-4">
            <div class="text-slate-500 font-medium">Requester</div>
            <div id="sumName" class="text-slate-800 font-bold text-right">-</div>
          </div>
          <div class="flex justify-between gap-4">
            <div class="text-slate-500 font-medium">Leave Type</div>
            <div id="sumType" class="text-slate-800 font-bold text-right">-</div>
          </div>
          <div class="flex justify-between gap-4">
            <div class="text-slate-500 font-medium">Date</div>
            <div id="sumDate" class="text-slate-800 font-bold text-right">-</div>
          </div>
          <div class="flex justify-between gap-4">
            <div class="text-slate-500 font-medium">Duration</div>
            <div id="sumDur" class="text-slate-800 font-bold text-right">-</div>
          </div>
        </div>

        <div id="sumNote" class="mt-3 text-[11px] text-slate-400 font-medium leading-relaxed">
          Please provide a clear reason for rejection. This remark will be shared with the requester.
        </div>
      </div>

      <!-- Remark -->
      <div class="space-y-2">
        <div class="flex items-center justify-between px-1">
          <label class="text-sm font-bold text-slate-700">Remark <span class="text-red-500">*</span></label>
          <span id="charCount" class="text-[11px] font-bold text-slate-400">0/500</span>
        </div>

        <textarea id="remark" rows="5" class="input resize-none" placeholder="Please explain why you reject this request..." oninput="onRemarkInput()"></textarea>

        <div id="remarkError" class="hidden bg-red-50 border border-red-100 rounded-lg p-3 flex items-start gap-3 shake-anim">
          <div class="text-red-500 mt-0.5">⚠️</div>
          <div>
            <p class="text-xs font-bold text-red-600">Remark required</p>
            <p class="text-[10px] text-red-500 leading-tight mt-0.5">
              Please enter a remark before submitting.
            </p>
          </div>
        </div>

        <div class="flex items-start gap-2 bg-slate-50 p-2.5 rounded-lg">
          <span class="text-slate-400 mt-0.5">ℹ️</span>
          <div class="text-[10px] text-slate-500 font-medium leading-relaxed">
            Tip: Keep it specific and actionable (e.g. “Insufficient handover plan”, “Overlapping critical meeting”, etc.)
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom action -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-5 pb-[calc(1.25rem+env(safe-area-inset-bottom))] z-40">
      <button id="submitBtn" onclick="handleSubmit()" class="w-full bg-gradient-to-r from-rose-600 to-rose-500 hover:from-rose-700 hover:to-rose-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-rose-500/25 active:scale-[0.98] transition-all">
        Submit Rejection
      </button>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center max-w-[200px]">
      <div class="w-12 h-12 border-4 border-slate-100 border-t-rose-600 rounded-full animate-spin mb-3"></div>
      <div class="font-bold text-slate-700 text-sm" id="loaderText">Processing...</div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const LIFF_ID = "2008997153-NcbVCWqs";
    const API_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec";
    // ======================

    let userProfile = null;
    let requestId = "";

    const $ = (id) => document.getElementById(id);

    function showLoader(msg){
      $("loaderText").textContent = msg || "Processing...";
      $("loader").classList.remove("hidden");
      $("loader").classList.add("flex");
    }
    function hideLoader(){
      $("loader").classList.add("hidden");
      $("loader").classList.remove("flex");
    }

    function onRemarkInput(){
      const v = $("remark").value || "";
      $("charCount").textContent = `${Math.min(v.length, 500)}/500`;
      $("remark").classList.remove("err");
      $("remarkError").classList.add("hidden");
      if (v.length > 500) $("remark").value = v.slice(0, 500);
    }

    async function fetchRequestSummary(reqId){
      try {
        const res = await fetch(API_URL + "?action=get_request&requestId=" + encodeURIComponent(reqId) + "&t=" + Date.now());
        const data = await res.json();
        if (!data || !data.ok || !data.request) return;

        const r = data.request;
        $("reqIdBadge").textContent = "ID: " + (reqId || "-");
        $("sumName").textContent = r.name || "-";

        let type = r.leaveType || "-";
        if (type === "Other" && r.otherSpecify) type = "Other (" + r.otherSpecify + ")";
        $("sumType").textContent = type;

        const s = r.startDate || "-";
        const e = r.endDate || "-";
        $("sumDate").textContent = (s && e) ? `${s} → ${e}` : "-";

        $("sumDur").textContent = r.dayPart || "-";
      } catch (e) {
        // ignore
      }
    }

    async function handleSubmit(){
      const remark = ($("remark").value || "").trim();
      if (!remark) {
        $("remark").classList.add("err");
        $("remarkError").classList.remove("hidden");
        return;
      }

      const btn = $("submitBtn");
      btn.disabled = true;
      btn.classList.add("opacity-70", "cursor-not-allowed");
      btn.textContent = "Submitting...";

      showLoader("Submitting...");

      try {
        // ส่ง text เข้าแชท เพื่อให้ webhook ฝั่งบอทไปอัปเดตสถานะ + push ผลกลับ requester
        // Format แนะนำ: LEAVE_REJECT:<requestId>:<remark>
        // หมายเหตุ: ถ้า remark ยาว/มีอักขระพิเศษ ก็ยังเป็น text ปกติ (แต่ควรจำกัด 500)
        await liff.sendMessages([{ type: "text", text: `LEAVE_REJECT:${requestId}:${remark}` }]);
        hideLoader();
        try { liff.closeWindow(); } catch(e) { alert("Submitted. Please close window."); }
      } catch (e) {
        hideLoader();
        alert("Send failed: " + (e.message || e));
        btn.disabled = false;
        btn.classList.remove("opacity-70", "cursor-not-allowed");
        btn.textContent = "Submit Rejection";
      }
    }

    async function init(){
      const params = new URLSearchParams(location.search);
      requestId = params.get("requestId") || "";

      showLoader("Loading...");

      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      userProfile = await liff.getProfile();
      $("userGreet").innerHTML = `Hi, <span class="font-bold text-slate-800">${userProfile.displayName}</span>`;
      if (userProfile.pictureUrl) {
        $("profileImg").src = userProfile.pictureUrl;
        $("avatarBox").classList.remove("hidden");
      }

      if (!requestId) {
        hideLoader();
        alert("Missing requestId");
        try { liff.closeWindow(); } catch(e){}
        return;
      }

      await fetchRequestSummary(requestId);
      onRemarkInput();
      hideLoader();
    }

    init().catch(err => {
      console.error(err);
      hideLoader();
      alert("LIFF init error: " + (err.message || err));
    });
  </script>
</body>
</html>
