<!-- =========================================================
  remark.html — Reject Remark (Approver) — Remark Only
  ---------------------------------------------------------
  ✅ หน้าเดียว: กรอก Remark แล้วบันทึก
  ✅ หลังบันทึกสำเร็จ: ส่งข้อความเข้า “แชทตัวเอง”:
        ปฏิเสธ:<requestId>
     เพื่อให้ LINE Webhook Bot reply Flex (Rejected) ในแชท Approver
     (และ Bot จะไป push แจ้งผลไป Requester ต่อเองตาม flow)
  ✅ บังคับกรอก Remark (ไม่ว่าง)
  ✅ Prefill ข้อมูล leave สั้นๆ (optional) เพื่อให้ approver เห็น context
  ✅ ไม่แก้ไขข้อมูลอื่นใด นอกจาก Remark + decision=REJECT

  Query params:
    requestId=...   (required)
========================================================= -->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Reject Remark</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f0f4f8; color:#0f172a; -webkit-tap-highlight-color: transparent; }
    .card { background:#fff; border-radius: 1.25rem; border:1px solid #eef2ff; box-shadow: 0 8px 30px rgba(15,23,42,0.06); padding: 1.1rem; }
    .input { background:#f8fafc; border:1px solid #e2e8f0; border-radius:.9rem; padding:.85rem; width:100%; outline:none; }
    .input:focus { border-color:#fca5a5; box-shadow: 0 0 0 3px rgba(239,68,68,.15); }
    .btn { border-radius: .95rem; padding:.95rem 1rem; font-weight:800; width:100%; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-ghost { background:#eef2ff; color:#1e3a8a; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; border-radius:999px; padding:.35rem .75rem; font-weight:800; font-size:.75rem; }
    .pill-red { background:#fee2e2; color:#991b1b; }
    .muted { color:#64748b; }
    .hint { font-size:.82rem; color:#64748b; line-height:1.35rem; }
    .hr { height:1px; background:#e2e8f0; margin: 1rem 0; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15,23,42,.92); color:#fff; padding: .75rem 1rem; border-radius: 999px;
      font-size: .9rem; display:none; z-index:9999;
      max-width: calc(100% - 32px); white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .loading { display:none; }
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 37%, #f1f5f9 63%); background-size: 400% 100%; animation: shimmer 1.2s ease-in-out infinite; border-radius: .8rem; }
    @keyframes shimmer { 0% { background-position: 100% 0 } 100% { background-position: -100% 0 } }
    .err { border-color:#ef4444 !important; background:#fef2f2 !important; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-xl mx-auto px-4 py-5">
    <div class="flex items-center justify-between mb-4">
      <div>
        <div class="text-xl font-extrabold tracking-tight">Reject Remark</div>
        <div class="text-sm muted">กรอกเหตุผลการปฏิเสธ (บังคับ)</div>
      </div>
      <div class="pill pill-red">REJECT</div>
    </div>

    <div class="card mb-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm font-bold">Approver</div>
          <div id="approverName" class="text-base font-extrabold">—</div>
          <div class="hint mt-1">บันทึกแล้วระบบจะส่ง “ปฏิเสธ:&lt;requestId&gt;” เข้าห้องแชทของคุณอัตโนมัติ ✅</div>
        </div>
        <div class="text-right">
          <div class="text-xs muted">Request ID</div>
          <div id="requestIdLabel" class="font-extrabold text-sm">—</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Optional: show leave summary -->
      <div id="summaryBox" class="hidden">
        <div class="text-sm font-bold mb-2">สรุปใบลา</div>
        <div class="grid grid-cols-1 gap-2 text-sm">
          <div class="flex justify-between"><span class="muted">ชื่อ</span><span id="sName" class="font-bold">—</span></div>
          <div class="flex justify-between"><span class="muted">ประเภท</span><span id="sType" class="font-bold">—</span></div>
          <div class="flex justify-between"><span class="muted">วันที่</span><span id="sDate" class="font-bold">—</span></div>
          <div class="flex justify-between"><span class="muted">ช่วงเวลา</span><span id="sPart" class="font-bold">—</span></div>
          <div class="flex justify-between"><span class="muted">จำนวนวัน</span><span id="sDays" class="font-bold">—</span></div>
          <div class="flex justify-between"><span class="muted">ไฟล์แนบ</span><span id="sAtt" class="font-bold">—</span></div>
        </div>
        <div class="hr"></div>
      </div>

      <div>
        <label class="text-sm font-bold">Remark (เหตุผลการปฏิเสธ)</label>
        <textarea id="remark" class="input mt-2" rows="5" placeholder="กรุณาระบุเหตุผลการปฏิเสธให้ชัดเจน..."></textarea>
        <div id="remarkErr" class="hint mt-2 hidden text-red-600">กรุณากรอก Remark ก่อนบันทึก</div>
      </div>

      <div class="grid grid-cols-1 gap-3 mt-4">
        <button id="btnReject" class="btn btn-danger">บันทึกการปฏิเสธ</button>
        <button id="btnClose" class="btn btn-ghost">ปิด</button>
      </div>

      <div id="loading" class="loading mt-3">
        <div class="skeleton h-10 w-full"></div>
        <div class="hint mt-2">กำลังบันทึก…</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/** ================= CONFIG ================= **/

// ✅ เปลี่ยนเป็น WebApp URL ของ Leave Backend (Apps Script)
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec";

// ✅ LIFF ID ของหน้า remark (ควรเป็น LIFF อีกตัว หรือ reuse ตัวเดียวก็ได้)
const LIFF_ID = "2008997153-NcbVCWqs";

/** ================= STATE ================= **/
const qs = new URLSearchParams(location.search);
const requestId = (qs.get("requestId") || "").trim();

let profile = { userId:"", displayName:"" };

/** ================= ELEMENTS ================= **/
const el = (id) => document.getElementById(id);
const approverName = el("approverName");
const requestIdLabel = el("requestIdLabel");
const remark = el("remark");
const remarkErr = el("remarkErr");
const btnReject = el("btnReject");
const btnClose = el("btnClose");
const loading = el("loading");
const toast = el("toast");

const summaryBox = el("summaryBox");
const sName = el("sName");
const sType = el("sType");
const sDate = el("sDate");
const sPart = el("sPart");
const sDays = el("sDays");
const sAtt = el("sAtt");

/** ================= UI HELPERS ================= **/
function showToast(msg, ms=2200) {
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", ms);
}
function setLoading(on) {
  loading.style.display = on ? "block" : "none";
  btnReject.disabled = on;
  btnClose.disabled = on;
  btnReject.style.opacity = on ? 0.7 : 1;
}
function validRemark() {
  const v = (remark.value || "").trim();
  const ok = v.length > 0;
  remark.classList.toggle("err", !ok);
  remarkErr.classList.toggle("hidden", ok);
  return ok;
}

/** ================= NETWORK ================= **/
async function apiGet(paramsObj) {
  const url = new URL(BACKEND_URL);
  Object.entries(paramsObj).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method: "GET" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}
async function apiPost(payload) {
  const res = await fetch(BACKEND_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json; charset=UTF-8" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

/** ================= PREFILL SUMMARY (optional) ================= **/
function fmtDateRange(s, e) {
  if (!s || !e) return "—";
  const a = String(s).slice(0,10);
  const b = String(e).slice(0,10);
  return a === b ? a : (a + " → " + b);
}
async function loadLeaveSummary() {
  if (!requestId) return;

  try {
    const data = await apiGet({ action: "get_leave", requestId });
    if (data && data.success && data.leave) {
      const L = data.leave;
      sName.textContent = L.name || "—";
      const type = L.leaveType || "—";
      const other = (type === "Other" && L.otherSpecify) ? ` (${L.otherSpecify})` : "";
      sType.textContent = type + other;
      sDate.textContent = fmtDateRange(L.startDate, L.endDate);
      sPart.textContent = L.dayPart || "—";
      sDays.textContent = (L.leaveDays != null) ? String(L.leaveDays) : "—";
      sAtt.textContent = L.attachmentUrl ? "✅ มีไฟล์แนบ" : "—";
      summaryBox.classList.remove("hidden");
    }
  } catch (e) {
    // ignore summary errors
    console.warn("summary load failed", e);
  }
}

/** ================= LIFF INIT ================= **/
async function initLIFF() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  const p = await liff.getProfile();
  profile = { userId: p.userId, displayName: p.displayName || "" };
  approverName.textContent = profile.displayName || "—";
}

/** ================= SUBMIT REJECT ================= **/
async function submitReject() {
  if (!requestId) { showToast("ไม่พบ requestId"); return; }
  if (!validRemark()) { showToast("กรุณากรอก Remark"); return; }

  setLoading(true);
  try {
    // 1) save reject remark to backend
    const payload = {
      action: "reject_leave",
      requestId,
      actorUserId: profile.userId,
      remark: remark.value.trim()
    };

    const res = await apiPost(payload);
    if (!res || !res.success) throw new Error(res && res.message ? res.message : "reject failed");

    showToast("บันทึกการปฏิเสธเรียบร้อยแล้ว ✅");

    // 2) send text to own chat so bot can reply flex + push requester
    const msgText = "ปฏิเสธ:" + requestId;
    await liff.sendMessages([{ type: "text", text: msgText }]);

    // 3) close
    setTimeout(() => liff.closeWindow(), 500);

  } catch (e) {
    console.error(e);
    showToast("บันทึกไม่สำเร็จ ลองใหม่อีกครั้งนะคะ");
  } finally {
    setLoading(false);
  }
}

/** ================= EVENTS ================= **/
remark.addEventListener("input", validRemark);
btnReject.addEventListener("click", submitReject);
btnClose.addEventListener("click", () => liff.closeWindow());

/** ================= BOOT ================= **/
(async function boot() {
  try {
    requestIdLabel.textContent = requestId || "—";
    setLoading(true);
    await initLIFF();
    await loadLeaveSummary();
  } catch (e) {
    console.error(e);
    showToast("เปิดหน้า Remark ไม่สำเร็จ");
  } finally {
    setLoading(false);
  }
})();
</script>
</body>
</html>
