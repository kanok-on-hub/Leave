<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Reject Remark</title>

  <!-- LIFF + Tailwind -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f0f4f8; color:#0f172a; -webkit-tap-highlight-color: transparent; }
    .card { background:#fff; border-radius: 1.25rem; border:1px solid #eef2ff; box-shadow: 0 8px 30px rgba(15,23,42,0.06); padding: 1.1rem; }
    .input { background:#f8fafc; border:1px solid #e2e8f0; border-radius:.9rem; padding:.85rem; width:100%; }
    .input:focus { outline:none; border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.10); }
    .btn { border-radius: .95rem; padding:.95rem 1rem; font-weight:800; }
    .btn-primary { background:#111827; color:#fff; }
    .btn-primary:active { transform: translateY(1px); }
    .btn-ghost { background:#f1f5f9; color:#0f172a; }
    .pill { border:1px solid #e2e8f0; background:#f8fafc; border-radius:999px; padding:.25rem .6rem; font-size:.75rem; color:#334155; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15, 23, 42, .92); color: #fff; padding: .75rem 1rem;
      border-radius: 999px; font-size: .85rem; box-shadow: 0 10px 25px rgba(0,0,0,.18);
      opacity: 0; pointer-events: none; transition: opacity .18s ease;
      max-width: calc(100% - 28px); text-align: center;
    }
    .toast.show { opacity: 1; }
    .err { border-color:#ef4444 !important; box-shadow: 0 0 0 4px rgba(239,68,68,.10) !important; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-md mx-auto px-4 py-5">
    <!-- Header -->
    <div class="mb-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xl font-extrabold tracking-tight">Reject Remark</div>
          <div class="text-slate-500 text-sm mt-1" id="subtitle">กรอกเหตุผลการไม่อนุมัติ แล้วกดบันทึก</div>
        </div>
        <span class="pill" id="modePill">Reject</span>
      </div>

      <div class="mt-3 card">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600">Approver</div>
          <div class="text-sm font-bold" id="displayName">-</div>
        </div>
        <div class="flex items-center justify-between mt-2">
          <div class="text-sm text-slate-600">Request ID</div>
          <div class="text-sm font-mono" id="requestIdText">-</div>
        </div>
      </div>
    </div>

    <!-- Remark -->
    <div class="card space-y-4">
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm font-bold">หมายเหตุ (Remark)</div>
          <div class="text-xs text-slate-500" id="reqInfo">บังคับกรอก</div>
        </div>
        <div class="text-xs text-slate-500 mt-2 leading-relaxed">
          ระบบจะบันทึกเหตุผลนี้และส่ง “ปฏิเสธ:&lt;requestId&gt;” เข้าแชทของคุณ เพื่อให้บอทอัปเดตสถานะเป็น Rejected อัตโนมัติ
        </div>
      </div>

      <div>
        <label class="text-sm font-bold text-slate-700 mb-2 block">เหตุผลการปฏิเสธ <span class="text-red-500">*</span></label>
        <textarea id="remark" class="input resize-none" rows="5" placeholder="เช่น ขอเอกสารเพิ่มเติม / วันที่ซ้อนกับงานสำคัญ / โปรดแก้ไขช่วงวันที่ลา ..."></textarea>
        <div class="text-xs text-slate-500 mt-2" id="hint">
          แนะนำ: เขียนให้ชัดเจนและ actionable เพื่อให้ Requester แก้ไขได้เร็ว
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 pt-1">
        <button class="btn btn-ghost" id="btnClose" type="button">ปิด</button>
        <button class="btn btn-primary" id="btnSave" type="button">บันทึก</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Toast</div>

<script>
/** =========================
 * CONFIG (แก้แค่ 2 จุดนี้)
 * ========================= */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec"; // Leave Backend Web App URL (doGet/doPost)
const LIFF_ID = "2008997153-NcbVCWqs"; // LIFF ID ของหน้า remark

/** =========================
 * STATE
 * ========================= */
const state = {
  requestId: "",
  userId: "",
  displayName: ""
};

/** =========================
 * UTILS
 * ========================= */
function qs(name) {
  const url = new URL(location.href);
  return url.searchParams.get(name) || "";
}
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1800);
}
function setLoading(isLoading) {
  const btn = document.getElementById("btnSave");
  btn.disabled = isLoading;
  btn.style.opacity = isLoading ? "0.65" : "1";
  btn.textContent = isLoading ? "กำลังบันทึก..." : "บันทึก";
}
async function backendPost(action, payload = {}) {
  const res = await fetch(BACKEND_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, ...payload })
  });
  const json = await res.json();
  if (!json || json.success !== true) throw new Error((json && json.error) || "Backend error");
  return json.data;
}

/** =========================
 * FLOW
 * ========================= */
function validate() {
  const el = document.getElementById("remark");
  el.classList.remove("err");
  const v = String(el.value || "").trim();
  if (!v) {
    el.classList.add("err");
    toast("กรุณากรอก Remark");
    return false;
  }
  return true;
}

async function saveRemarkAndSendText() {
  try {
    if (!state.requestId) { toast("ไม่พบ requestId"); return; }
    if (!validate()) return;

    setLoading(true);

    const remark = String(document.getElementById("remark").value || "").trim();

    // 1) Save reject remark to backend
    // Backend should:
    // - Verify actor is approver (optional)
    // - Save remark to Leave_Requests.Remark
    // - (Optional) set status to "REJECTED_PENDING" หรือยังไม่เปลี่ยนก็ได้ แล้วให้ bot เปลี่ยน
    await backendPost("save_reject_remark", {
      requestId: state.requestId,
      actorUserId: state.userId,
      actorName: state.displayName,
      remark
    });

    // 2) Send text to my own chat so bot can handle rejection loop
    // format exactly as you asked:
    const text = `ปฏิเสธ:${state.requestId}`;
    await liff.sendMessages([{ type: "text", text }]);

    toast("บันทึกแล้ว ✅");
    setTimeout(() => liff.closeWindow(), 350);

  } catch (err) {
    console.error(err);
    toast("บันทึกไม่สำเร็จ");
  } finally {
    setLoading(false);
  }
}

/** =========================
 * INIT
 * ========================= */
async function init() {
  // read requestId from query
  state.requestId = qs("requestId");
  document.getElementById("requestIdText").textContent = state.requestId || "-";

  // init LIFF
  if (LIFF_ID && LIFF_ID !== "PUT_YOUR_LIFF_ID_HERE") {
    await liff.init({ liffId: LIFF_ID });
  } else {
    await liff.init({});
  }

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  // profile
  const profile = await liff.getProfile();
  state.userId = profile.userId;
  state.displayName = profile.displayName || "-";
  document.getElementById("displayName").textContent = state.displayName;

  // bind
  document.getElementById("btnClose").addEventListener("click", () => {
    try { liff.closeWindow(); } catch(e) { window.close(); }
  });
  document.getElementById("btnSave").addEventListener("click", saveRemarkAndSendText);

  // keyboard UX: cmd/ctrl+enter to save
  document.getElementById("remark").addEventListener("keydown", (ev) => {
    if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") saveRemarkAndSendText();
  });
}

init().catch(err => {
  console.error(err);
  toast("เปิดหน้า Remark ไม่สำเร็จ");
});
</script>
</body>
</html>
