<!-- =========================================================
  index.html — Leave Request LIFF (Create/Edit + Prefill)
  ---------------------------------------------------------
  ✅ create + edit ในไฟล์เดียว
  ✅ prefill จาก backend (Apps Script WebApp) ด้วย requestId
  ✅ ห้ามเลือกวันย้อนหลัง (start/end < today)
  ✅ คำนวณ LeaveDays แบบ realtime (ไม่นับ weekend + holiday)
  ✅ เช็ค remaining (อ่านจาก Leave_Balance) + เตือนถ้าเกิน
  ✅ submit แล้ว “ส่งข้อความเข้าแชทตัวเอง”:
        LEAVE_DRAFT:<requestId>
     (เพื่อให้ bot reply Flex (Draft) ต่อในแชท)
  ✅ รองรับเปิดจาก Flex ปุ่ม “แก้ไข”:
        ...?mode=edit&requestId=xxxx

  NOTE:
  - ไฟล์นี้ต้องอยู่ใน GH Pages (หรือ host ที่ https)
  - ต้องมี backend (Apps Script WebApp) ที่รองรับ endpoints ใน BACKEND_URL

  Query params:
    mode=create|edit   (default=create)
    requestId=...      (required when mode=edit)
========================================================= -->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f0f4f8; color:#0f172a; -webkit-tap-highlight-color: transparent; }
    .card { background:#fff; border-radius: 1.25rem; border:1px solid #eef2ff; box-shadow: 0 8px 30px rgba(15,23,42,0.06); padding: 1.1rem; }
    .input { background:#f8fafc; border:1px solid #e2e8f0; border-radius: .9rem; padding:.85rem; width:100%; outline:none; }
    .input:focus { border-color:#93c5fd; box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
    .btn { border-radius: .95rem; padding:.9rem 1rem; font-weight:700; width:100%; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-primary:active { transform: scale(.99); }
    .btn-ghost { background:#eef2ff; color:#1e3a8a; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; border-radius: 999px; padding:.35rem .75rem; font-weight:700; font-size:.75rem; }
    .pill-blue { background:#eef2ff; color:#1e3a8a; }
    .pill-green{ background:#dcfce7; color:#166534; }
    .pill-red  { background:#fee2e2; color:#991b1b; }
    .muted { color:#64748b; }
    .hint { font-size:.82rem; color:#64748b; line-height:1.35rem; }
    .hr { height:1px; background:#e2e8f0; margin: 1rem 0; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15,23,42,.92); color:#fff; padding: .75rem 1rem; border-radius: 999px;
      font-size: .9rem; display:none; z-index:9999;
      max-width: calc(100% - 32px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .loading { display:none; }
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 37%, #f1f5f9 63%); background-size: 400% 100%; animation: shimmer 1.2s ease-in-out infinite; border-radius: .8rem; }
    @keyframes shimmer { 0% { background-position: 100% 0 } 100% { background-position: -100% 0 } }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-xl mx-auto px-4 py-5">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <div class="text-xl font-extrabold tracking-tight">Leave Request</div>
        <div id="subTitle" class="text-sm muted">กรอกข้อมูลเพื่อส่งคำขอลา</div>
      </div>
      <div id="modePill" class="pill pill-blue">MODE</div>
    </div>

    <!-- Status/Info -->
    <div class="card mb-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm font-bold">ผู้ขอลา</div>
          <div id="profileName" class="text-base font-extrabold">—</div>
          <div id="profileHint" class="hint">ระบบจะส่งผล “Draft” เข้าห้องแชทของคุณอัตโนมัติหลังบันทึก ✅</div>
        </div>
        <div class="text-right">
          <div class="text-xs muted">Request ID</div>
          <div id="requestIdLabel" class="font-extrabold text-sm">—</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-xs muted mb-1">Remaining (แสดงเพื่อเช็ค)</div>
          <div id="remainingBox" class="text-sm font-extrabold">—</div>
        </div>
        <div class="text-right">
          <div class="text-xs muted mb-1">Leave Days</div>
          <div id="daysBox" class="text-sm font-extrabold">0</div>
        </div>
      </div>

      <div id="warnBox" class="mt-3 hidden">
        <div class="pill pill-red">⚠️ Remaining ไม่พอ</div>
        <div class="hint mt-2">จำนวนวันลาที่ขอมากกว่าวันคงเหลือ กรุณาปรับวันที่/ประเภทการลา</div>
      </div>
    </div>

    <!-- Form -->
    <div class="card">
      <div class="grid grid-cols-1 gap-3">
        <!-- Leave Type -->
        <div>
          <label class="text-sm font-bold">ประเภทการลา</label>
          <select id="leaveType" class="input mt-2">
            <option value="" disabled selected>เลือกประเภทการลา</option>
            <option value="Annual">Annual Leave</option>
            <option value="Sick">Sick Leave</option>
            <option value="Personal">Personal Leave</option>
            <option value="Other">Other</option>
          </select>
          <div class="hint mt-2">หมายเหตุ: ลาป่วยตั้งแต่ 3 วันขึ้นไป ต้องแนบใบรับรองแพทย์ในแชทหลังส่ง Draft</div>
        </div>

        <!-- Other Specify -->
        <div id="otherWrap" class="hidden">
          <label class="text-sm font-bold">ระบุเพิ่มเติม (Other)</label>
          <input id="otherSpecify" class="input mt-2" placeholder="เช่น ไปทำธุระราชการ / งานครอบครัว ฯลฯ" />
        </div>

        <!-- Dates -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-bold">เริ่มลา</label>
            <input id="startDate" type="date" class="input mt-2" />
            <div id="startHint" class="hint mt-2 hidden">ไม่สามารถเลือกวันย้อนหลังได้</div>
          </div>
          <div>
            <label class="text-sm font-bold">ถึง</label>
            <input id="endDate" type="date" class="input mt-2" />
            <div id="endHint" class="hint mt-2 hidden">ไม่สามารถเลือกวันย้อนหลังได้</div>
          </div>
        </div>

        <!-- Day Part -->
        <div>
          <label class="text-sm font-bold">ช่วงเวลา</label>
          <select id="dayPart" class="input mt-2">
            <option value="Full Day" selected>Full Day</option>
            <option value="Half Day (AM)">Half Day (AM)</option>
            <option value="Half Day (PM)">Half Day (PM)</option>
          </select>
          <div class="hint mt-2">ถ้าเลือก Half Day จะคำนวณเป็น 0.5 วัน (เฉพาะกรณีลา 1 วัน)</div>
        </div>

        <!-- Reason -->
        <div>
          <label class="text-sm font-bold">เหตุผล</label>
          <textarea id="reason" class="input mt-2" rows="4" placeholder="ระบุเหตุผลการลา..."></textarea>
        </div>

        <!-- Buttons -->
        <div class="grid grid-cols-1 gap-3 mt-2">
          <button id="btnSave" class="btn btn-primary">บันทึก (Draft)</button>
          <button id="btnClose" class="btn btn-ghost">ปิด</button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading mt-2">
          <div class="skeleton h-10 w-full"></div>
          <div class="hint mt-2">กำลังบันทึกข้อมูล…</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/** ================= CONFIG (Front) ================= **/

// ✅ เปลี่ยนเป็น URL WebApp ของ Leave Backend (Apps Script) ที่ deploy แล้ว
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec";

// local timezone handling
const pad2 = (n) => String(n).padStart(2, '0');
const toISODate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const todayISO = () => toISODate(new Date());

/** ================= STATE ================= **/
const qs = new URLSearchParams(location.search);
const MODE = (qs.get("mode") || "create").toLowerCase();     // create | edit
let requestId = (qs.get("requestId") || "").trim();

let profile = { userId:"", displayName:"" };
let holidaysSet = new Set(); // 'YYYY-MM-DD'
let remainingMap = {};       // { Annual: 10, Sick: 5, ... }

/** ================= ELEMENTS ================= **/
const el = (id) => document.getElementById(id);

const modePill = el("modePill");
const subTitle = el("subTitle");
const profileName = el("profileName");
const requestIdLabel = el("requestIdLabel");
const remainingBox = el("remainingBox");
const daysBox = el("daysBox");
const warnBox = el("warnBox");

const leaveType = el("leaveType");
const otherWrap = el("otherWrap");
const otherSpecify = el("otherSpecify");
const startDate = el("startDate");
const endDate = el("endDate");
const startHint = el("startHint");
const endHint = el("endHint");
const dayPart = el("dayPart");
const reason = el("reason");

const btnSave = el("btnSave");
const btnClose = el("btnClose");
const loading = el("loading");
const toast = el("toast");

/** ================= UI HELPERS ================= **/
function showToast(msg, ms=2200) {
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", ms);
}
function setLoading(on) {
  loading.style.display = on ? "block" : "none";
  btnSave.disabled = on;
  btnClose.disabled = on;
  btnSave.style.opacity = on ? 0.7 : 1;
}
function setModeUI() {
  if (MODE === "edit") {
    modePill.textContent = "EDIT";
    modePill.className = "pill pill-green";
    subTitle.textContent = "แก้ไขคำขอเดิม (Draft)";
  } else {
    modePill.textContent = "CREATE";
    modePill.className = "pill pill-blue";
    subTitle.textContent = "สร้างคำขอลาใหม่ (Draft)";
  }
}

/** ================= NETWORK ================= **/
async function apiGet(paramsObj) {
  const url = new URL(BACKEND_URL);
  Object.entries(paramsObj).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method: "GET" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}
async function apiPost(payload) {
  const res = await fetch(BACKEND_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json; charset=UTF-8" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

/** ================= DATE RULES ================= **/
function isPastDate(iso) {
  if (!iso) return false;
  return iso < todayISO(); // ISO compare works for YYYY-MM-DD
}
function clampMinToday() {
  const t = todayISO();
  startDate.min = t;
  endDate.min = t;
}

/** ================= CALC: working days ================= **/
function isWeekend(iso) {
  const d = new Date(iso + "T00:00:00");
  const day = d.getDay(); // 0 Sun, 6 Sat
  return day === 0 || day === 6;
}

function calcLeaveDays() {
  const t = leaveType.value;
  const s = startDate.value;
  const e = endDate.value;

  // basic validation
  if (!t || !s || !e) return 0;
  if (e < s) return 0;

  // Range count (exclude weekend+holiday)
  let days = 0;
  let cur = new Date(s + "T00:00:00");
  const end = new Date(e + "T00:00:00");

  while (cur <= end) {
    const iso = toISODate(cur);
    if (!isWeekend(iso) && !holidaysSet.has(iso)) days += 1;
    cur.setDate(cur.getDate() + 1);
  }

  // Half day logic: only allowed when single working day
  const dp = dayPart.value;
  if (dp.startsWith("Half Day") && days === 1) days = 0.5;

  return days;
}

/** ================= REMAINING CHECK ================= **/
function updateRemainingUI() {
  const t = leaveType.value;
  const rem = (t && remainingMap[t] != null) ? remainingMap[t] : null;
  remainingBox.textContent = rem == null ? "—" : `${rem} day(s)`;

  const days = calcLeaveDays();
  daysBox.textContent = String(days || 0);

  if (rem != null && days > rem) warnBox.classList.remove("hidden");
  else warnBox.classList.add("hidden");
}

/** ================= PREFILL / INIT ================= **/
async function initLIFF() {
  await liff.init({ liffId: "2008997153-n5oIYKUP" });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }
  const p = await liff.getProfile();
  profile = { userId: p.userId, displayName: p.displayName || "" };
  profileName.textContent = profile.displayName || "—";
}

async function loadReferenceData() {
  // holidays + remaining in one call (recommended)
  const data = await apiGet({
    action: "liff_bootstrap",
    userId: profile.userId
  });

  if (!data || !data.success) throw new Error(data && data.message ? data.message : "bootstrap failed");

  // holidays
  holidaysSet = new Set((data.holidays || []).map(String));

  // remaining
  remainingMap = data.remaining || {};
}

async function prefillIfEdit() {
  if (MODE !== "edit") return;
  if (!requestId) {
    showToast("ไม่พบ requestId สำหรับการแก้ไข");
    return;
  }

  const data = await apiGet({
    action: "get_leave",
    requestId: requestId
  });

  if (!data || !data.success || !data.leave) throw new Error("prefill failed");

  const L = data.leave;

  // owner check (optional UI)
  if (L.userId && profile.userId && String(L.userId) !== String(profile.userId)) {
    showToast("ใบลานี้ไม่ใช่ของบัญชีคุณ");
  }

  requestIdLabel.textContent = String(L.requestId || requestId);

  // set fields
  leaveType.value = L.leaveType || "";
  if (leaveType.value === "Other") {
    otherWrap.classList.remove("hidden");
    otherSpecify.value = L.otherSpecify || "";
  } else {
    otherWrap.classList.add("hidden");
    otherSpecify.value = "";
  }

  startDate.value = (L.startDate || "").slice(0,10);
  endDate.value = (L.endDate || "").slice(0,10);
  dayPart.value = L.dayPart || "Full Day";
  reason.value = L.reason || "";

  updateRemainingUI();
}

async function ensureRequestId() {
  // create mode: create requestId on load
  if (MODE === "edit") {
    requestIdLabel.textContent = requestId || "—";
    return;
  }

  const data = await apiGet({
    action: "new_request_id",
    userId: profile.userId
  });

  if (!data || !data.success || !data.requestId) throw new Error("cannot create requestId");

  requestId = String(data.requestId);
  requestIdLabel.textContent = requestId;
}

/** ================= VALIDATION ================= **/
function validateForm() {
  const t = leaveType.value;
  const s = startDate.value;
  const e = endDate.value;
  const r = reason.value.trim();

  if (!t) return "กรุณาเลือกประเภทการลา";
  if (t === "Other" && !otherSpecify.value.trim()) return "กรุณาระบุรายละเอียด (Other)";
  if (!s) return "กรุณาเลือกวันเริ่มลา";
  if (!e) return "กรุณาเลือกวันสิ้นสุด";
  if (e < s) return "วันสิ้นสุดต้องไม่ก่อนวันเริ่ม";
  if (isPastDate(s) || isPastDate(e)) return "ไม่สามารถเลือกวันย้อนหลังได้";
  if (!r) return "กรุณาระบุเหตุผล";

  const days = calcLeaveDays();
  if (!days || days <= 0) return "จำนวนวันลาเป็น 0 (อาจตรง weekend/holiday ทั้งหมด)";

  // remaining check (soft fail, allow save but warn)
  return "";
}

/** ================= SAVE ================= **/
async function onSave() {
  const err = validateForm();
  if (err) { showToast(err); return; }

  const payload = {
    action: "save_leave_draft",
    requestId,
    userId: profile.userId,
    name: profile.displayName,
    leaveType: leaveType.value,
    otherSpecify: (leaveType.value === "Other") ? otherSpecify.value.trim() : "",
    startDate: startDate.value,
    endDate: endDate.value,
    dayPart: dayPart.value,
    reason: reason.value.trim(),
    leaveDays: calcLeaveDays()
  };

  setLoading(true);
  try {
    const res = await apiPost(payload);
    if (!res || !res.success) throw new Error(res && res.message ? res.message : "save failed");

    showToast("บันทึกข้อมูลเรียบร้อยแล้ว ✅");

    // ✅ send text to own chat so bot can reply Flex (Draft)
    const msgText = "LEAVE_DRAFT:" + requestId;

    await liff.sendMessages([{ type: "text", text: msgText }]);

    // close liff
    setTimeout(() => liff.closeWindow(), 500);
  } catch (e) {
    console.error(e);
    showToast("บันทึกไม่สำเร็จ ลองใหม่อีกครั้งนะคะ");
  } finally {
    setLoading(false);
  }
}

/** ================= EVENTS ================= **/
leaveType.addEventListener("change", () => {
  if (leaveType.value === "Other") otherWrap.classList.remove("hidden");
  else { otherWrap.classList.add("hidden"); otherSpecify.value = ""; }
  updateRemainingUI();
});

[startDate, endDate, dayPart, otherSpecify, reason].forEach(x => {
  x.addEventListener("input", () => {
    // prevent past-date selection hints
    startHint.classList.toggle("hidden", !(startDate.value && isPastDate(startDate.value)));
    endHint.classList.toggle("hidden", !(endDate.value && isPastDate(endDate.value)));
    updateRemainingUI();
  });
});

btnSave.addEventListener("click", onSave);
btnClose.addEventListener("click", () => liff.closeWindow());

/** ================= BOOT ================= **/
(async function boot() {
  try {
    setModeUI();
    clampMinToday();

    setLoading(true);

    await initLIFF();
    await loadReferenceData();

    await ensureRequestId();
    await prefillIfEdit();

    updateRemainingUI();

  } catch (e) {
    console.error(e);
    showToast("เปิดฟอร์มไม่สำเร็จ กรุณาลองใหม่");
  } finally {
    setLoading(false);
  }
})();
</script>
</body>
</html>
