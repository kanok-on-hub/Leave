<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>

  <!-- LIFF + Tailwind -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f0f4f8; color:#0f172a; -webkit-tap-highlight-color: transparent; }
    .card { background:#fff; border-radius: 1.25rem; border:1px solid #eef2ff; box-shadow: 0 8px 30px rgba(15,23,42,0.06); padding: 1.1rem; }
    .input { background:#f8fafc; border:1px solid #e2e8f0; border-radius:.9rem; padding:.85rem; width:100%; }
    .input:focus { outline:none; border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.10); }
    .label { font-size:.85rem; color:#334155; margin-bottom:.35rem; display:block; }
    .btn { border-radius: .95rem; padding:.95rem 1rem; font-weight:700; }
    .btn-primary { background:#111827; color:#fff; }
    .btn-primary:active { transform: translateY(1px); }
    .btn-ghost { background:#f1f5f9; color:#0f172a; }
    .pill { border:1px solid #e2e8f0; background:#f8fafc; border-radius:999px; padding:.25rem .6rem; font-size:.75rem; color:#334155; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15, 23, 42, .92); color: #fff; padding: .75rem 1rem;
      border-radius: 999px; font-size: .85rem; box-shadow: 0 10px 25px rgba(0,0,0,.18);
      opacity: 0; pointer-events: none; transition: opacity .18s ease;
      max-width: calc(100% - 28px); text-align: center;
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-md mx-auto px-4 py-5">
    <!-- Header -->
    <div class="mb-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xl font-extrabold tracking-tight">ฟอร์มขอลา</div>
          <div class="text-slate-500 text-sm mt-1" id="subtitle">กรอกข้อมูลให้ครบ แล้วกดส่งคำขอ</div>
        </div>
        <span class="pill" id="modePill">Create</span>
      </div>

      <div class="mt-3 card">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600">ผู้ขอลา</div>
          <div class="text-sm font-bold" id="displayName">-</div>
        </div>
        <div class="flex items-center justify-between mt-2">
          <div class="text-sm text-slate-600">Request ID</div>
          <div class="text-sm font-mono" id="requestIdText">-</div>
        </div>
      </div>
    </div>

    <!-- Form -->
    <div class="card space-y-4">
      <!-- Leave Type -->
      <div>
        <label class="label">ประเภทการลา</label>
        <select class="input" id="leaveType">
          <option value="">-- เลือก --</option>
          <option value="Annual">ลาพักร้อน (Annual)</option>
          <option value="Sick">ลาป่วย (Sick)</option>
          <option value="Personal">ลากิจ (Personal)</option>
          <option value="Other">อื่น ๆ (Other)</option>
        </select>
        <div class="mt-2 hidden" id="otherWrap">
          <label class="label">ระบุประเภทอื่น ๆ</label>
          <input class="input" id="otherSpecify" placeholder="เช่น ลาเพื่อธุระสำคัญ..." />
        </div>
      </div>

      <!-- Date -->
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="label">วันที่เริ่มลา</label>
          <input class="input" type="date" id="startDate" />
        </div>
        <div>
          <label class="label">วันที่สิ้นสุด</label>
          <input class="input" type="date" id="endDate" />
        </div>
      </div>

      <!-- Day part -->
      <div>
        <label class="label">ช่วงเวลา</label>
        <select class="input" id="dayPart">
          <option value="Full Day">เต็มวัน (Full Day)</option>
          <option value="Half Day AM">ครึ่งวันเช้า (Half Day AM)</option>
          <option value="Half Day PM">ครึ่งวันบ่าย (Half Day PM)</option>
        </select>
        <div class="text-xs text-slate-500 mt-2" id="halfDayHint">
          * ครึ่งวันใช้ได้เมื่อเลือกวันเดียวกันเท่านั้น
        </div>
      </div>

      <!-- Reason -->
      <div>
        <label class="label">เหตุผลการลา</label>
        <textarea class="input" id="reason" rows="3" placeholder="ระบุเหตุผลโดยย่อ..."></textarea>
      </div>

      <!-- Summary -->
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm font-bold">สรุป</div>
          <div class="text-xs text-slate-500" id="calcNote">คำนวณอัตโนมัติ</div>
        </div>

        <div class="mt-3 space-y-2 text-sm">
          <div class="flex justify-between">
            <div class="text-slate-600">จำนวนวันลา</div>
            <div class="font-bold" id="leaveDaysText">0</div>
          </div>
          <div class="flex justify-between">
            <div class="text-slate-600">คงเหลือ (Remaining)</div>
            <div class="font-bold" id="remainingText">-</div>
          </div>
          <div class="flex justify-between">
            <div class="text-slate-600">ผลตรวจสอบ</div>
            <div class="font-bold" id="validText">-</div>
          </div>
        </div>

        <div class="mt-3 text-xs text-slate-500" id="holidayInfo">
          * ระบบจะไม่นับวันเสาร์-อาทิตย์ และวันหยุด (ถ้ามีในฐานข้อมูล)
        </div>
      </div>

      <!-- Actions -->
      <div class="grid grid-cols-2 gap-3 pt-1">
        <button class="btn btn-ghost" id="btnClose" type="button">ปิด</button>
        <button class="btn btn-primary" id="btnSubmit" type="button">ส่งคำขอ</button>
      </div>

      <div class="text-xs text-slate-500 leading-relaxed">
        เมื่อกด “ส่งคำขอ” ระบบจะบันทึก Draft แล้วส่งข้อความเข้าแชทอัตโนมัติ เพื่อให้บอทสรุปเป็น Flex ให้ยืนยัน/แก้ไขต่อค่ะ
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Toast</div>

<script>
/** =========================
 * CONFIG (แก้แค่ 2 จุดนี้)
 * ========================= */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec"; // Leave Backend Web App URL (doGet/doPost)
const LIFF_ID = "2008997153-n5oIYKUP"; // ถ้า init ด้วย liffId (optional). ถ้าไม่ใส่จะใช้ liff.init({}) ได้เช่นกัน

/** =========================
 * STATE
 * ========================= */
const state = {
  mode: "create",     // create | edit
  requestId: "",
  userId: "",
  displayName: "",
  holidays: new Set(), // yyyy-mm-dd
  remainingByType: {}, // { Annual: 10, Sick: 30 ... }
  computedDays: 0,
  computedRemaining: null,
  isValid: false,
  invalidMsg: ""
};

/** =========================
 * UTILS
 * ========================= */
function qs(name) {
  const url = new URL(location.href);
  return url.searchParams.get(name) || "";
}
function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1800);
}
function setLoading(isLoading) {
  const btn = document.getElementById("btnSubmit");
  btn.disabled = isLoading;
  btn.style.opacity = isLoading ? "0.65" : "1";
  btn.textContent = isLoading ? "กำลังส่ง..." : "ส่งคำขอ";
}
function isWeekend(dateObj) {
  const day = dateObj.getDay();
  return day === 0 || day === 6;
}
function toISO(dateObj) {
  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth()+1).padStart(2,"0");
  const dd = String(dateObj.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function parseISO(s) {
  // s: yyyy-mm-dd
  const [y,m,d] = String(s).split("-").map(Number);
  return new Date(y, (m||1)-1, d||1);
}
function clampMinDateInputs() {
  const min = todayISO();
  document.getElementById("startDate").setAttribute("min", min);
  document.getElementById("endDate").setAttribute("min", min);
}

/** =========================
 * BACKEND CALLS
 * ========================= */
async function backendGet(action, params = {}) {
  const url = new URL(BACKEND_URL);
  url.searchParams.set("action", action);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, String(v)));
  const res = await fetch(url.toString(), { method: "GET" });
  const json = await res.json();
  if (!json || json.success !== true) throw new Error((json && json.error) || "Backend error");
  return json.data;
}
async function backendPost(action, payload = {}) {
  const res = await fetch(BACKEND_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, ...payload })
  });
  const json = await res.json();
  if (!json || json.success !== true) throw new Error((json && json.error) || "Backend error");
  return json.data;
}

/** =========================
 * CALC
 * ========================= */
function getForm() {
  const leaveType = document.getElementById("leaveType").value.trim();
  const otherSpecify = document.getElementById("otherSpecify").value.trim();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const dayPart = document.getElementById("dayPart").value;
  const reason = document.getElementById("reason").value.trim();
  return { leaveType, otherSpecify, startDate, endDate, dayPart, reason };
}

function computeLeaveDays(startISO, endISO, dayPart) {
  if (!startISO || !endISO) return 0;
  const s = parseISO(startISO);
  const e = parseISO(endISO);
  if (isNaN(s.getTime()) || isNaN(e.getTime())) return 0;
  if (e < s) return 0;

  // half day rules
  if (dayPart !== "Full Day") {
    if (startISO !== endISO) return 0; // invalid (we'll handle message)
    // half day counts 0.5 and still should avoid weekend/holiday (if that date is non-working, count 0)
    const iso = startISO;
    const isHol = state.holidays.has(iso);
    const isWk = isWeekend(s);
    if (isHol || isWk) return 0;
    return 0.5;
  }

  // full day count: exclude weekends + holidays
  let days = 0;
  let cur = new Date(s.getTime());
  while (cur <= e) {
    const iso = toISO(cur);
    const hol = state.holidays.has(iso);
    if (!isWeekend(cur) && !hol) days += 1;
    cur.setDate(cur.getDate() + 1);
  }
  return days;
}

function validateAndRender() {
  const f = getForm();

  // show/hide other
  document.getElementById("otherWrap").classList.toggle("hidden", f.leaveType !== "Other");

  // Remaining
  const rem = (f.leaveType && state.remainingByType.hasOwnProperty(f.leaveType))
    ? Number(state.remainingByType[f.leaveType])
    : null;

  // Calculate
  const days = computeLeaveDays(f.startDate, f.endDate, f.dayPart);
  state.computedDays = days;
  state.computedRemaining = rem;

  // Validation
  state.isValid = true;
  state.invalidMsg = "";

  // required fields
  if (!f.leaveType) { state.isValid = false; state.invalidMsg = "กรุณาเลือกประเภทการลา"; }
  else if (f.leaveType === "Other" && !f.otherSpecify) { state.isValid = false; state.invalidMsg = "กรุณาระบุประเภทอื่น ๆ"; }
  else if (!f.startDate || !f.endDate) { state.isValid = false; state.invalidMsg = "กรุณาเลือกวันที่ให้ครบ"; }
  else if (f.endDate < f.startDate) { state.isValid = false; state.invalidMsg = "วันที่สิ้นสุดต้องไม่ก่อนวันที่เริ่มลา"; }
  else {
    // no backdate (hard block)
    const min = todayISO();
    if (f.startDate < min || f.endDate < min) {
      state.isValid = false; state.invalidMsg = "ไม่สามารถเลือกวันย้อนหลังได้";
    }
    // half day rule
    if (f.dayPart !== "Full Day" && f.startDate !== f.endDate) {
      state.isValid = false; state.invalidMsg = "ครึ่งวันใช้ได้เมื่อเลือกวันเดียวกันเท่านั้น";
    }
    // must be > 0 working day
    if (state.isValid && days <= 0) {
      state.isValid = false; state.invalidMsg = "ช่วงวันที่เลือกไม่มีวันทำงานที่นับเป็นวันลา";
    }
    // remaining check
    if (state.isValid && rem !== null && !Number.isNaN(rem) && days > rem) {
      state.isValid = false; state.invalidMsg = "วันลามากกว่าวันคงเหลือ";
    }
    // reason required (ถ้าคุณอยากบังคับ)
    if (state.isValid && !f.reason) {
      state.isValid = false; state.invalidMsg = "กรุณาระบุเหตุผลการลา";
    }
  }

  // Render summary
  document.getElementById("leaveDaysText").textContent = String(days);
  document.getElementById("remainingText").textContent =
    (rem === null || Number.isNaN(rem)) ? "-" : String(rem);

  document.getElementById("validText").textContent =
    state.isValid ? "ผ่าน ✅" : (state.invalidMsg ? ("ไม่ผ่าน: " + state.invalidMsg) : "ไม่ผ่าน ❌");

  // enable/disable submit
  document.getElementById("btnSubmit").disabled = !state.isValid;
  document.getElementById("btnSubmit").style.opacity = state.isValid ? "1" : "0.55";
}

/** =========================
 * PREFILL
 * ========================= */
async function loadInitData() {
  // Fetch holidays + remaining
  // Backend should return:
  // - holidays: ["2026-01-01", ...]
  // - remainingByType: { Annual: 10, Sick: 30, Personal: 3, Other: 0 }
  const data = await backendGet("init", { userId: state.userId });

  const holidays = Array.isArray(data.holidays) ? data.holidays : [];
  state.holidays = new Set(holidays.map(String));

  state.remainingByType = (data.remainingByType && typeof data.remainingByType === "object")
    ? data.remainingByType : {};

  validateAndRender();
}

async function prefillEdit(requestId) {
  // Backend should return request object:
  // { requestId, leaveType, otherSpecify, startDate, endDate, dayPart, reason }
  const data = await backendGet("get_request", { requestId, userId: state.userId });

  state.requestId = String(data.requestId || requestId || "");
  document.getElementById("requestIdText").textContent = state.requestId || "-";

  document.getElementById("leaveType").value = String(data.leaveType || "");
  document.getElementById("otherSpecify").value = String(data.otherSpecify || "");
  document.getElementById("startDate").value = String(data.startDate || "");
  document.getElementById("endDate").value = String(data.endDate || "");
  document.getElementById("dayPart").value = String(data.dayPart || "Full Day");
  document.getElementById("reason").value = String(data.reason || "");

  validateAndRender();
}

/** =========================
 * SUBMIT (save draft + send text to chat)
 * ========================= */
async function submitDraft() {
  try {
    setLoading(true);

    const f = getForm();
    validateAndRender();
    if (!state.isValid) {
      toast(state.invalidMsg || "กรอกข้อมูลไม่ครบ");
      return;
    }

    const payload = {
      requestId: state.requestId || "",   // empty => backend creates new
      userId: state.userId,
      displayName: state.displayName,
      leaveType: f.leaveType,
      otherSpecify: f.otherSpecify,
      startDate: f.startDate,
      endDate: f.endDate,
      dayPart: f.dayPart,
      reason: f.reason,
      leaveDays: state.computedDays
    };

    // Backend should return { requestId }
    const data = await backendPost("save_draft", payload);
    const rid = String(data.requestId || "");

    if (!rid) throw new Error("No requestId returned");

    state.requestId = rid;
    document.getElementById("requestIdText").textContent = rid;

    // Send text to chat so Bot can reply Flex Draft
    const text = `LEAVE_DRAFT:${rid}`;
    await liff.sendMessages([{ type: "text", text }]);

    toast("ส่งคำขอแล้ว ✅");
    setTimeout(() => liff.closeWindow(), 350);

  } catch (err) {
    console.error(err);
    toast("เกิดข้อผิดพลาดในการส่งคำขอ");
  } finally {
    setLoading(false);
  }
}

/** =========================
 * LIFF INIT
 * ========================= */
async function init() {
  // UI min date (no backdate)
  clampMinDateInputs();

  // read mode + requestId from query
  const mode = (qs("mode") || "create").toLowerCase();
  const requestId = qs("requestId");

  state.mode = (mode === "edit") ? "edit" : "create";
  document.getElementById("modePill").textContent = state.mode === "edit" ? "Edit" : "Create";
  document.getElementById("subtitle").textContent =
    state.mode === "edit" ? "แก้ไขข้อมูล แล้วกดส่งคำขอ" : "สร้างคำขอใหม่ แล้วกดส่งคำขอ";

  // init LIFF
  if (LIFF_ID && LIFF_ID !== "PUT_YOUR_LIFF_ID_HERE") {
    await liff.init({ liffId: LIFF_ID });
  } else {
    await liff.init({}); // ใช้ได้ถ้าผูก LIFF ถูกต้อง
  }

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  // profile
  const profile = await liff.getProfile();
  state.userId = profile.userId;
  state.displayName = profile.displayName || "-";
  document.getElementById("displayName").textContent = state.displayName;

  // requestId text (edit shows id; create shows - until saved)
  if (state.mode === "edit" && requestId) {
    state.requestId = requestId;
    document.getElementById("requestIdText").textContent = requestId;
  } else {
    document.getElementById("requestIdText").textContent = "-";
  }

  // fetch init data
  await loadInitData();

  // prefill if edit
  if (state.mode === "edit" && requestId) {
    await prefillEdit(requestId);
  }

  // bind listeners
  bindEvents();
  validateAndRender();
}

function bindEvents() {
  const ids = ["leaveType","otherSpecify","startDate","endDate","dayPart","reason"];
  ids.forEach(id => {
    document.getElementById(id).addEventListener("input", validateAndRender);
    document.getElementById(id).addEventListener("change", validateAndRender);
  });

  document.getElementById("btnClose").addEventListener("click", () => {
    try { liff.closeWindow(); } catch(e) { window.close(); }
  });

  document.getElementById("btnSubmit").addEventListener("click", submitDraft);
}

/** =========================
 * START
 * ========================= */
init().catch(err => {
  console.error(err);
  toast("เปิดฟอร์มไม่สำเร็จ");
});
</script>
</body>
</html>
