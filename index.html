<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Plus Jakarta Sans',sans-serif; background:#f0f4f8; color:#1e293b; -webkit-tap-highlight-color:transparent; }
    ::-webkit-scrollbar { width:0; background:transparent; }
    .card { background:#fff; border-radius:1.25rem; box-shadow:0 4px 20px -2px rgba(226,232,240,.6); border:1px solid #f1f5f9; padding:1.25rem; }
    .type-btn{ width:100%; text-align:left; padding:1rem; border:1px solid transparent; border-radius:1rem; background:#f8fafc; color:#64748b; transition:.2s; position:relative; overflow:hidden;}
    .type-btn:active{ transform:scale(.98); }
    .type-btn.selected{ border-color:#3b82f6; background:#eff6ff; color:#1d4ed8; box-shadow:0 4px 12px rgba(59,130,246,.15); font-weight:600;}
    .type-btn.selected::after{ content:'‚úì'; position:absolute; top:8px; right:10px; font-size:12px; color:#2563eb; }
    .input{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:.75rem; padding:.875rem; width:100%; outline:none; transition:.2s; font-size:.95rem; color:#334155; }
    .input:focus{ background:#fff; border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.1); }
    .err{ border-color:#ef4444!important; background:#fef2f2!important; box-shadow:0 0 0 4px rgba(239,68,68,.1)!important; }
    .info-badge{ font-size:11px; font-weight:700; background:#eff6ff; color:#2563eb; padding:4px 12px; border-radius:9999px; border:1px solid #dbeafe; box-shadow:0 1px 2px rgba(0,0,0,.05); display:inline-flex; align-items:center; white-space:nowrap;}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .shake-anim{ animation:shake .4s ease-in-out; }
  </style>
</head>

<body class="pb-32">
  <div class="max-w-md mx-auto min-h-screen flex flex-col">
    <div class="bg-white px-6 pt-12 pb-8 rounded-b-[2.5rem] shadow-[0_10px_40px_-10px_rgba(0,0,0,0.05)] mb-6 relative z-10">
      <div class="flex items-center gap-4">
        <div id="avatarBox" class="w-14 h-14 rounded-full overflow-hidden border-2 border-white shadow-lg ring-2 ring-blue-50 hidden">
          <img id="profileImg" src="" class="w-full h-full object-cover">
        </div>
        <div>
          <h1 id="title" class="text-2xl font-bold text-slate-800 tracking-tight">Leave Request üìù</h1>
          <p id="userGreet" class="text-slate-500 text-sm font-medium mt-0.5 flex items-center gap-1">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Loading...
          </p>
        </div>
      </div>
    </div>

    <div class="px-5 space-y-6 flex-1" id="formUI">
      <!-- Leave Type -->
      <div class="space-y-3">
        <div class="flex justify-between items-center px-1 h-7">
          <label class="text-sm font-bold text-slate-700">Leave Type <span class="text-red-500">*</span></label>
          <span id="remainingBox" class="hidden info-badge">Remaining:&nbsp;<span id="remainingValue" class="ml-0.5">-</span></span>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button type="button" onclick="selectType(this,'Sick')" class="type-btn group">
            <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">ü§í</div>
            <span class="text-sm font-medium">Sick Leave</span>
          </button>
          <button type="button" onclick="selectType(this,'Annual')" class="type-btn group">
            <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">üèñÔ∏è</div>
            <span class="text-sm font-medium">Annual Leave</span>
          </button>
          <button type="button" onclick="selectType(this,'Personal')" class="type-btn group">
            <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">üöó</div>
            <span class="text-sm font-medium">Personal Leave</span>
          </button>
          <button type="button" onclick="selectType(this,'Other')" class="type-btn group">
            <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">üìù</div>
            <span class="text-sm font-medium">Other</span>
          </button>
        </div>
        <input type="hidden" id="leaveTypeValue">
      </div>

      <div id="otherField" class="hidden space-y-2">
        <label class="text-sm font-bold text-blue-600 ml-1 italic">Please specify Other type *</label>
        <input type="text" id="otherSpecify" class="input" placeholder="e.g. Ordination">
      </div>

      <!-- Date -->
      <div class="card space-y-4">
        <div class="flex items-center justify-between border-b border-slate-100 pb-3 h-10">
          <label class="text-sm font-bold text-slate-700">Date <span class="text-red-500">*</span></label>
          <span id="dayBadge" class="info-badge hidden">Working: 0 Days</span>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1.5">
            <div class="text-[11px] uppercase tracking-wider font-bold text-slate-400">Start Date</div>
            <input type="date" id="startDate" class="input text-center text-slate-700 font-medium cursor-pointer" onchange="validateOnFly()">
          </div>
          <div class="space-y-1.5">
            <div class="text-[11px] uppercase tracking-wider font-bold text-slate-400">End Date</div>
            <input type="date" id="endDate" class="input text-center text-slate-700 font-medium cursor-pointer" onchange="validateOnFly()">
          </div>
        </div>

        <div id="quotaError" class="hidden bg-red-50 border border-red-100 rounded-lg p-3 flex items-start gap-3 shake-anim">
          <div class="text-red-500 mt-0.5">‚ö†Ô∏è</div>
          <div>
            <p class="text-xs font-bold text-red-600">Quota Exceeded</p>
            <p class="text-[10px] text-red-500 leading-tight mt-0.5">
              You requested <span id="reqDaysDisplay" class="font-bold"></span> days, but you only have
              <span id="remDaysDisplay" class="font-bold"></span> days remaining.
            </p>
          </div>
        </div>

        <div class="flex items-start gap-2 bg-slate-50 p-2.5 rounded-lg">
          <span class="text-slate-400 mt-0.5">‚ÑπÔ∏è</span>
          <div class="text-[10px] text-slate-500 font-medium leading-relaxed">
            Weekends & Company Holidays are automatically excluded from the calculation.
          </div>
        </div>
      </div>

      <!-- Duration -->
      <div class="card space-y-3">
        <label class="text-sm font-bold text-slate-700 block">Duration <span class="text-red-500">*</span></label>
        <div class="flex bg-slate-100 p-1.5 rounded-xl gap-1">
          <button type="button" onclick="selectDur(this,'Full Day')" class="dur-btn flex-1 py-2.5 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600 ring-1 ring-black/5">Full Day</button>
          <button type="button" onclick="selectDur(this,'Morning')" class="dur-btn flex-1 py-2.5 text-sm font-medium text-slate-500 hover:text-slate-700">Morning</button>
          <button type="button" onclick="selectDur(this,'Afternoon')" class="dur-btn flex-1 py-2.5 text-sm font-medium text-slate-500 hover:text-slate-700">Afternoon</button>
        </div>
        <input type="hidden" id="durationValue" value="Full Day">
      </div>

      <!-- Reason -->
      <div class="space-y-2">
        <label class="text-sm font-bold text-slate-700 ml-1">Reason <span class="text-red-500">*</span></label>
        <textarea id="reason" rows="3" class="input resize-none" placeholder="Please specify your reason clearly..." oninput="validateOnFly()"></textarea>
      </div>

      <!-- Attachment (optional) -->
      <div id="fileCard" class="card border-dashed border-2 border-slate-200 hover:border-blue-400 hover:bg-blue-50/30 transition-colors flex items-center justify-between cursor-pointer group" onclick="document.getElementById('fileInput').click()">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
            </svg>
          </div>
          <div>
            <p id="fileTitle" class="text-sm font-bold text-slate-700 group-hover:text-blue-700 transition-colors">Attachment (Optional)</p>
            <p class="text-[11px] text-slate-400 font-medium">Required if Sick Leave ‚â• 3 days</p>
          </div>
        </div>
        <input type="file" id="fileInput" class="hidden" onchange="handleFileChange()" accept="image/*,application/pdf">
        <div class="text-slate-300 group-hover:text-blue-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </div>
      </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-5 pb-[calc(1.25rem+env(safe-area-inset-bottom))] z-40">
      <button id="submitBtn" onclick="handleSubmit()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-500/30 active:scale-[0.98] transition-all">
        Submit
      </button>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center max-w-[180px]">
      <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin mb-3"></div>
      <div class="font-bold text-slate-700 text-sm" id="loaderText">Processing...</div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const LIFF_ID = "2008997153-OdZGJzVg";
    const API_URL = "https://script.google.com/macros/s/AKfycbw3PCZGZG_puGPUY_FdDYAR765UUs8Wr2ERJDzXmOz-nOLt_V25JkUSdrWXNFNk3-h4/exec";
    // ======================

    let companyHolidays = [];
    let userProfile = null;
    let leaveBalances = {};
    let mode = "create";
    let editingRequestId = "";

    const $ = (id) => document.getElementById(id);

    function showLoader(msg){
      $("loaderText").textContent = msg || "Processing...";
      $("loader").classList.remove("hidden");
      $("loader").classList.add("flex");
    }
    function hideLoader(){
      $("loader").classList.add("hidden");
      $("loader").classList.remove("flex");
    }

    function selectType(btn, val) {
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      $('leaveTypeValue').value = val;

      if (val === 'Other') $('otherField').classList.remove('hidden');
      else { $('otherField').classList.add('hidden'); $('otherSpecify').value = ''; }

      updateRemainingUI();
      validateOnFly();
    }

    function selectTypeByValue(val){
      const btns = Array.from(document.querySelectorAll(".type-btn"));
      const target = btns.find(b => (b.getAttribute("onclick")||"").includes("'" + val + "'"));
      if (target) selectType(target, val);
      else {
        // fallback: just set hidden value
        $('leaveTypeValue').value = val;
        if (val === 'Other') $('otherField').classList.remove('hidden');
        updateRemainingUI();
      }
    }

    function selectDur(btn, val) {
      document.querySelectorAll('.dur-btn').forEach(b => {
        b.className = "dur-btn flex-1 py-2.5 text-sm font-medium text-slate-500 hover:text-slate-700";
        b.disabled = false;
      });
      btn.className = "dur-btn flex-1 py-2.5 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600 ring-1 ring-black/5";
      $('durationValue').value = val;
      validateOnFly();
    }

    function selectDurByValue(val){
      const btns = Array.from(document.querySelectorAll(".dur-btn"));
      const target = btns.find(b => (b.textContent||"").trim().toLowerCase() === String(val||"").trim().toLowerCase());
      if (target) selectDur(target, val);
      else $('durationValue').value = val || "Full Day";
    }

    function handleFileChange() {
      const f = $('fileInput').files[0];
      if (f) {
        $('fileTitle').textContent = f.name.length > 24 ? f.name.slice(0,24) + "..." : f.name;
        $('fileTitle').classList.add('text-blue-600');
      } else {
        $('fileTitle').textContent = "Attachment (Optional)";
        $('fileTitle').classList.remove('text-blue-600');
      }
      validateOnFly();
    }

    async function fetchHolidays() {
      try {
        const res = await fetch(API_URL + "?action=get_holidays&t=" + Date.now());
        const data = await res.json();
        companyHolidays = Array.isArray(data) ? data : [];
      } catch (e) {
        companyHolidays = [];
      }
    }

    async function fetchLeaveBalance(userId) {
      if (!userId) return;
      try {
        const res = await fetch(API_URL + "?action=get_balance&userId=" + encodeURIComponent(userId) + "&t=" + Date.now());
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.balances)) {
          leaveBalances = {};
          data.balances.forEach(b => {
            if (!b || !b.type) return;
            const key = String(b.type);
            const remaining = Number(b.remaining);
            leaveBalances[key] = isNaN(remaining) ? 0 : remaining;
          });
        }
      } catch (e) {
        leaveBalances = {};
      }
      updateRemainingUI();
    }

    function updateRemainingUI() {
      const type = $('leaveTypeValue').value;
      const box = $('remainingBox');
      const valEl = $('remainingValue');

      if (!type) { box.classList.add('hidden'); return; }
      const remaining = (leaveBalances[type] != null) ? leaveBalances[type] : null;
      if (remaining == null) box.classList.add('hidden');
      else {
        const unit = (remaining === 1) ? "Day" : "Days";
        valEl.textContent = `${remaining} ${unit}`;
        box.classList.remove('hidden');
      }
    }

    function calcWorkingDays(sStr, eStr) {
      if (!sStr || !eStr) return 0;
      const s = new Date(sStr);
      const e = new Date(eStr);
      if (isNaN(s.getTime()) || isNaN(e.getTime()) || s > e) return 0;

      let total = 0;
      const cur = new Date(s);
      while (cur <= e) {
        const dow = cur.getDay();
        const isWeekend = (dow === 0 || dow === 6);
        const dateStr = cur.toISOString().split('T')[0];
        const isHoliday = Array.isArray(companyHolidays) && companyHolidays.includes(dateStr);
        if (!isWeekend && !isHoliday) total++;
        cur.setDate(cur.getDate() + 1);
      }
      return total;
    }

    function enforceNoPastDates_() {
      // your original rule: prevent selecting past dates
      const today = new Date().toISOString().split('T')[0];
      $("startDate").setAttribute("min", today);
      $("endDate").setAttribute("min", today);

      // if current values somehow are in the past, clamp to today
      if ($("startDate").value && $("startDate").value < today) $("startDate").value = today;
      if ($("endDate").value && $("endDate").value < today) $("endDate").value = today;
    }

    function validateOnFly() {
      const type = $('leaveTypeValue').value;
      const s = $('startDate').value;
      const e = $('endDate').value;
      const badge = $('dayBadge');
      const quotaError = $('quotaError');

      enforceNoPastDates_();

      $('startDate').classList.remove('err');
      $('endDate').classList.remove('err');
      $('fileCard').classList.remove('err');
      $('fileTitle').classList.remove('text-red-600');
      quotaError.classList.add('hidden');

      if (!s || !e) { badge.classList.add('hidden'); return true; }
      if (!Array.isArray(companyHolidays)) { badge.classList.add('hidden'); return true; }

      let days = calcWorkingDays(s, e);

      // lock half-day if multiple days
      const durBtns = document.querySelectorAll('.dur-btn');
      if (days > 1) {
        if ($('durationValue').value !== 'Full Day') selectDur(durBtns[0], 'Full Day');
        durBtns[1].disabled = true;
        durBtns[2].disabled = true;
        durBtns[1].classList.add('opacity-40', 'cursor-not-allowed', 'bg-slate-50');
        durBtns[2].classList.add('opacity-40', 'cursor-not-allowed', 'bg-slate-50');
      } else {
        durBtns[1].disabled = false; durBtns[2].disabled = false;
        durBtns[1].classList.remove('opacity-40', 'cursor-not-allowed', 'bg-slate-50');
        durBtns[2].classList.remove('opacity-40', 'cursor-not-allowed', 'bg-slate-50');
      }

      const dp = $('durationValue').value || "Full Day";
      if ((dp === "Morning" || dp === "Afternoon") && days > 0) days -= 0.5;

      const unit = (days === 1) ? "Day" : "Days";
      badge.textContent = `Working: ${days} ${unit}`;
      badge.classList.remove('hidden');

      // rule: sick >= 3 requires file (client-side guard)
      const file = $('fileInput').files[0];
      if (type === 'Sick' && days >= 3 && !file) {
        $('fileCard').classList.add('err');
        $('fileTitle').textContent = "Medical Cert. Required! *";
        $('fileTitle').classList.add('text-red-600');
        return false;
      }

      // quota exceeded
      const remaining = (type && leaveBalances[type] != null) ? leaveBalances[type] : null;
      if (type && remaining != null && days > 0 && days > remaining) {
        $('startDate').classList.add('err');
        $('endDate').classList.add('err');
        $('reqDaysDisplay').textContent = days;
        $('remDaysDisplay').textContent = remaining;
        quotaError.classList.remove('hidden');
        return false;
      }

      return true;
    }

    function toISODateFromAny(v){
      return String(v || "").trim(); // already yyyy-mm-dd
    }

    async function getRequestAndPrefill(requestId){
      showLoader("Loading...");
      try {
        const res = await fetch(API_URL + "?action=get_request&requestId=" + encodeURIComponent(requestId) + "&t=" + Date.now());
        const data = await res.json();
        if (!data || !data.ok || !data.request) {
          hideLoader();
          alert("Cannot load request for edit.");
          return;
        }
        const req = data.request;

        // ownership check (edit only for requester)
        if (req.userId && userProfile && req.userId !== userProfile.userId) {
          hideLoader();
          alert("This request is not yours.");
          try { liff.closeWindow(); } catch(e){}
          return;
        }

        // prefill
        if (req.leaveType) selectTypeByValue(req.leaveType);
        if (req.leaveType === "Other") {
          $("otherField").classList.remove("hidden");
          $("otherSpecify").value = req.otherSpecify || "";
        } else {
          $("otherSpecify").value = req.otherSpecify || "";
        }

        $("startDate").value = toISODateFromAny(req.startDate);
        $("endDate").value = toISODateFromAny(req.endDate);

        // keep no-past rule
        enforceNoPastDates_();

        selectDurByValue(req.dayPart || "Full Day");
        $("reason").value = req.reason || "";

        // attachment indicator (no auto download)
        if (req.attachmentUrl) {
          $("fileTitle").textContent = "‚úÖ Attached already (add new if needed)";
          $("fileTitle").classList.add("text-blue-600");
        } else {
          // reset (if previously edited)
          const f = $('fileInput');
          try { f.value = ""; } catch(e){}
          $("fileTitle").textContent = "Attachment (Optional)";
          $("fileTitle").classList.remove("text-blue-600");
        }

        validateOnFly();
        hideLoader();
      } catch (e) {
        hideLoader();
        alert("Cannot load request for edit.");
      }
    }

    async function submitDraftToBackend(payload, file){
      const form = new FormData();
      Object.keys(payload).forEach(k => form.append(k, payload[k] == null ? "" : String(payload[k])));
      form.append("action", "upsert_draft");
      if (file) form.append("file", file);

      const res = await fetch(API_URL, { method:"POST", body: form });
      return await res.json();
    }

    async function handleSubmit() {
      const type = $('leaveTypeValue').value;
      const startDate = $('startDate').value;
      const endDate = $('endDate').value;
      const reason = $('reason').value.trim();
      const otherSpec = $('otherSpecify').value.trim();
      const file = $('fileInput').files[0];

      if (!type) return alert("Please select Leave Type");
      if (type === 'Other' && !otherSpec) return alert("Please specify Other type");
      if (!startDate || !endDate) return alert("Please select dates");
      if (!reason) return alert("Please specify reason");
      if (!validateOnFly()) return alert("Please check errors (Red fields).");

      const btn = $('submitBtn');
      btn.disabled = true;
      btn.textContent = "Sending...";
      btn.classList.add('opacity-70', 'cursor-not-allowed');

      showLoader(mode === "edit" ? "Updating..." : "Submitting...");

      const requestId = (mode === "edit" && editingRequestId) ? editingRequestId : ""; // create new if empty
      const payload = {
        action: "upsert_draft",
        requestId,
        userId: userProfile?.userId || "",
        name: userProfile?.displayName || "",
        leaveType: type,
        otherSpecify: otherSpec,
        startDate, // ISO yyyy-mm-dd
        endDate,   // ISO yyyy-mm-dd
        dayPart: $('durationValue').value || "Full Day",
        reason
      };

      try{
        const data = await submitDraftToBackend(payload, file);
        if (!data || !data.ok) {
          hideLoader();
          alert(data?.error ? String(data.error) : "Submit failed");
          btn.disabled = false;
          btn.textContent = "Submit";
          btn.classList.remove('opacity-70','cursor-not-allowed');
          return;
        }

        const finalRequestId = data.requestId;

        // send to chat so bot can reply Flex draft loop
        await liff.sendMessages([{ type:"text", text: `LEAVE_DRAFT:${finalRequestId}` }]);

        hideLoader();
        try { liff.closeWindow(); } catch(e) { alert("Saved. Please close window."); }
      } catch(e){
        hideLoader();
        alert("Network error: " + (e.message || e));
        btn.disabled = false;
        btn.textContent = "Submit";
        btn.classList.remove('opacity-70','cursor-not-allowed');
      }
    }

    async function init() {
      const params = new URLSearchParams(location.search);
      mode = (params.get("mode") || "create").toLowerCase();
      editingRequestId = params.get("requestId") || "";

      showLoader("Loading...");

      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      userProfile = await liff.getProfile();
      $('userGreet').innerHTML = `Hi, <span class="font-bold text-slate-800">${userProfile.displayName}</span>`;
      if (userProfile.pictureUrl) {
        $('profileImg').src = userProfile.pictureUrl;
        $('avatarBox').classList.remove('hidden');
      }

      // defaults (create only)
      const today = new Date().toISOString().split('T')[0];
      $('startDate').setAttribute("min", today);
      $('endDate').setAttribute("min", today);

      // balances + holidays first (so prefill can validate quota correctly)
      await fetchLeaveBalance(userProfile.userId);
      await fetchHolidays();

      if (mode === "edit" && editingRequestId) {
        $("title").textContent = "Edit Leave ‚úèÔ∏è";
        await getRequestAndPrefill(editingRequestId);
      } else {
        // initial values for create
        $('startDate').value = today;
        $('endDate').value = today;
        enforceNoPastDates_();
        validateOnFly();
        hideLoader();
      }
    }

    init().catch(err => {
      console.error(err);
      hideLoader();
      alert("LIFF init error: " + (err.message || err));
    });
  </script>
</body>
</html>
