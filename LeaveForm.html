<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover" />
  <title>Leave Request</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <div class="max-w-md mx-auto p-5 space-y-4">
    <div class="bg-white rounded-2xl p-5 shadow">
      <div class="text-xl font-extrabold text-slate-800">Leave Request üìù</div>
      <div id="hello" class="text-sm text-slate-500 mt-1">Loading...</div>
    </div>

    <div class="bg-white rounded-2xl p-5 shadow space-y-4">
      <div>
        <div class="text-sm font-bold text-slate-700 mb-2">Leave Type *</div>
        <div class="grid grid-cols-2 gap-2">
          <button class="typeBtn px-4 py-3 rounded-xl bg-slate-50" onclick="pickType('Sick')">ü§í Sick</button>
          <button class="typeBtn px-4 py-3 rounded-xl bg-slate-50" onclick="pickType('Annual')">üèñÔ∏è Annual</button>
          <button class="typeBtn px-4 py-3 rounded-xl bg-slate-50" onclick="pickType('Personal')">üöó Personal</button>
          <button class="typeBtn px-4 py-3 rounded-xl bg-slate-50" onclick="pickType('Other')">üìù Other</button>
        </div>
        <input type="hidden" id="leaveType" />
      </div>

      <div id="otherBox" class="hidden">
        <div class="text-sm font-bold text-slate-700 mb-2">Other Specify *</div>
        <input id="otherSpecify" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó" />
      </div>

      <div>
        <div class="text-sm font-bold text-slate-700 mb-2">Date *</div>
        <div class="grid grid-cols-2 gap-2">
          <input id="startDate" type="date" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" onchange="recalc()" />
          <input id="endDate" type="date" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" onchange="recalc()" />
        </div>
        <div class="text-xs text-slate-500 mt-2">
          Working days: <span id="days" class="font-bold">0</span>
        </div>
      </div>

      <div>
        <div class="text-sm font-bold text-slate-700 mb-2">Duration *</div>
        <div class="flex gap-2">
          <button class="durBtn flex-1 px-4 py-3 rounded-xl bg-slate-900 text-white" onclick="pickDur('Full Day')">Full</button>
          <button class="durBtn flex-1 px-4 py-3 rounded-xl bg-slate-50" onclick="pickDur('Morning')">Morning</button>
          <button class="durBtn flex-1 px-4 py-3 rounded-xl bg-slate-50" onclick="pickDur('Afternoon')">Afternoon</button>
        </div>
        <input type="hidden" id="dayPart" value="Full Day"/>
      </div>

      <div>
        <div class="text-sm font-bold text-slate-700 mb-2">Reason *</div>
        <textarea id="reason" rows="3" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•"></textarea>
      </div>

      <div class="text-xs text-slate-500">
        * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ ‚â• 3 ‡∏ß‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ/‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      </div>
    </div>

    <button id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow" onclick="submitDraft()">
      Submit (Draft)
    </button>

    <div id="msg" class="text-xs text-slate-500 text-center"></div>
  </div>

<script>
  // ====== CONFIG ======
  const LIFF_ID = "2008997153-n5oIYKUP";
  const API_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec"; // same GAS deployment
  const DRAFT_PREFIX = "LEAVE_DRAFT:";
  // ====================

  let profile = null;
  let holidays = [];
  let balances = {};

  const $ = (id)=>document.getElementById(id);

  function setMsg(t){ $("msg").textContent = t || ""; }

  function pickType(t){
    $("leaveType").value = t;
    document.querySelectorAll(".typeBtn").forEach(b=>b.className="typeBtn px-4 py-3 rounded-xl bg-slate-50");
    event.target.className="typeBtn px-4 py-3 rounded-xl bg-blue-50 border border-blue-200 font-bold";

    if(t==="Other") $("otherBox").classList.remove("hidden");
    else { $("otherBox").classList.add("hidden"); $("otherSpecify").value=""; }
    recalc();
  }

  function pickDur(d){
    $("dayPart").value = d;
    document.querySelectorAll(".durBtn").forEach(b=>b.className="durBtn flex-1 px-4 py-3 rounded-xl bg-slate-50");
    event.target.className="durBtn flex-1 px-4 py-3 rounded-xl bg-slate-900 text-white";
    recalc();
  }

  async function fetchHolidays(){
    const res = await fetch(API_URL + "?action=get_holidays&t=" + Date.now());
    const data = await res.json();
    holidays = Array.isArray(data) ? data : [];
  }

  function calcWorkingDays(sStr, eStr){
    if(!sStr || !eStr) return 0;
    const s = new Date(sStr), e = new Date(eStr);
    if(isNaN(s.getTime()) || isNaN(e.getTime()) || s>e) return 0;
    let total=0; const cur=new Date(s);
    while(cur<=e){
      const dow = cur.getDay();
      const iso = cur.toISOString().split("T")[0];
      const isWeekend = dow===0 || dow===6;
      const isHoliday = holidays.includes(iso);
      if(!isWeekend && !isHoliday) total++;
      cur.setDate(cur.getDate()+1);
    }
    const dp = $("dayPart").value || "Full Day";
    if((dp==="Morning"||dp==="Afternoon") && total>0) total -= 0.5;
    return total;
  }

  function recalc(){
    const s = $("startDate").value;
    const e = $("endDate").value;
    $("days").textContent = calcWorkingDays(s,e);
  }

  async function submitDraft(){
    const leaveType = $("leaveType").value;
    const otherSpecify = $("otherSpecify").value.trim();
    const startDate = $("startDate").value;
    const endDate = $("endDate").value;
    const dayPart = $("dayPart").value;
    const reason = $("reason").value.trim();

    if(!leaveType) return alert("Please select Leave Type");
    if(leaveType==="Other" && !otherSpecify) return alert("Please specify Other");
    if(!startDate || !endDate) return alert("Please select dates");
    if(!reason) return alert("Please fill reason");

    const leaveDays = calcWorkingDays(startDate,endDate);

    $("submitBtn").disabled = true;
    $("submitBtn").textContent = "Submitting...";
    setMsg("Creating draft...");

    try{
      const requestId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          action:"create_draft",
          requestId,
          userId: profile?.userId || "",
          name: profile?.displayName || "",
          leaveType,
          otherSpecify,
          startDate, endDate,
          dayPart,
          reason,
          leaveDays
        })
      });
      const data = await res.json();
      if(!data || !data.ok) throw new Error(data?.error || "create_draft_failed");

      // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó reply Flex (Draft)
      await liff.sendMessages([{ type:"text", text: DRAFT_PREFIX + data.requestId }]);
      setMsg("Sent to chat ‚úÖ");
      liff.closeWindow();
    }catch(e){
      console.error(e);
      alert("Submit failed: " + (e.message || e));
      $("submitBtn").disabled = false;
      $("submitBtn").textContent = "Submit (Draft)";
      setMsg("");
    }
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    profile = await liff.getProfile();
    $("hello").textContent = `Hi, ${profile.displayName}`;

    const today = new Date().toISOString().split("T")[0];
    $("startDate").value = today;
    $("endDate").value = today;
    $("startDate").min = today;
    $("endDate").min = today;

    await fetchHolidays();
    recalc();
    setMsg("");
  }

  init().catch(err=>{
    console.error(err);
    alert("LIFF init error: " + (err.message||err));
  });
</script>
</body>
</html>
