<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f0f4f8; color:#0f172a; -webkit-tap-highlight-color: transparent; }
    .card { background:#fff; border-radius: 1.25rem; border:1px solid #eef2ff; box-shadow: 0 8px 30px rgba(15,23,42,0.06); padding: 1.1rem; }
    .input { background:#f8fafc; border:1px solid #e2e8f0; border-radius:.9rem; padding:.85rem; width:100%; outline:none; }
    .input:focus { background:#fff; border-color:#3b82f6; box-shadow: 0 0 0 4px rgba(59,130,246,.12); }
    .type-btn { background:#f8fafc; border:1px solid transparent; border-radius: 1rem; padding: 1rem; text-align:left; }
    .type-btn.selected { border-color:#3b82f6; background:#eff6ff; color:#1d4ed8; font-weight:700; }
    .badge { font-size:11px; font-weight:800; background:#eff6ff; color:#2563eb; padding:4px 12px; border-radius:9999px; border:1px solid #dbeafe; }
    .err { border-color:#ef4444 !important; background:#fef2f2 !important; box-shadow:0 0 0 4px rgba(239,68,68,.10) !important; }
  </style>
</head>

<body class="pb-32">
  <div class="max-w-md mx-auto min-h-screen flex flex-col">
    <div class="bg-white px-6 pt-10 pb-7 rounded-b-[2.5rem] shadow-[0_10px_40px_-10px_rgba(0,0,0,0.06)] mb-6">
      <div class="flex items-center gap-4">
        <div id="avatarBox" class="w-12 h-12 rounded-full overflow-hidden border-2 border-white shadow ring-2 ring-blue-50 hidden">
          <img id="profileImg" src="" class="w-full h-full object-cover" />
        </div>
        <div>
          <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Leave Request üìù</h1>
          <p id="userGreet" class="text-slate-500 text-sm font-semibold mt-0.5">Loading‚Ä¶</p>
        </div>
      </div>
    </div>

    <div class="px-5 space-y-6 flex-1">
      <div class="space-y-3">
        <div class="flex justify-between items-center px-1">
          <label class="text-sm font-extrabold text-slate-700">Leave Type <span class="text-red-500">*</span></label>
          <span id="remainingBox" class="badge hidden">Remaining: <span id="remainingValue">-</span></span>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button type="button" class="type-btn" onclick="selectType(this,'Sick')">ü§í <div class="text-sm font-semibold mt-1">Sick</div></button>
          <button type="button" class="type-btn" onclick="selectType(this,'Annual')">üèñÔ∏è <div class="text-sm font-semibold mt-1">Annual</div></button>
          <button type="button" class="type-btn" onclick="selectType(this,'Personal')">üöó <div class="text-sm font-semibold mt-1">Personal</div></button>
          <button type="button" class="type-btn" onclick="selectType(this,'Other')">üìù <div class="text-sm font-semibold mt-1">Other</div></button>
        </div>
        <input type="hidden" id="leaveTypeValue" />
      </div>

      <div id="otherField" class="hidden space-y-2">
        <label class="text-sm font-extrabold text-blue-700 ml-1 italic">Please specify Other type *</label>
        <input type="text" id="otherSpecify" class="input" placeholder="e.g. Ordination" />
      </div>

      <div class="card space-y-4">
        <div class="flex items-center justify-between border-b border-slate-100 pb-3">
          <label class="text-sm font-extrabold text-slate-700">Date <span class="text-red-500">*</span></label>
          <span id="dayBadge" class="badge hidden">Working: 0 Days</span>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1.5">
            <div class="text-[11px] uppercase tracking-wider font-extrabold text-slate-400">Start Date</div>
            <input type="date" id="startDate" class="input text-center font-semibold" onchange="validateOnFly()" />
          </div>
          <div class="space-y-1.5">
            <div class="text-[11px] uppercase tracking-wider font-extrabold text-slate-400">End Date</div>
            <input type="date" id="endDate" class="input text-center font-semibold" onchange="validateOnFly()" />
          </div>
        </div>

        <div class="flex items-start gap-2 bg-slate-50 p-2.5 rounded-lg">
          <span class="text-slate-400 mt-0.5">‚ÑπÔ∏è</span>
          <div class="text-[11px] text-slate-500 font-semibold leading-relaxed">
            Weekends & Company Holidays are excluded automatically.
          </div>
        </div>
      </div>

      <div class="card space-y-3">
        <label class="text-sm font-extrabold text-slate-700 block">Duration <span class="text-red-500">*</span></label>
        <div class="flex bg-slate-100 p-1.5 rounded-xl gap-1">
          <button type="button" onclick="selectDur(this,'Full Day')" class="dur-btn flex-1 py-2.5 text-sm font-extrabold rounded-lg bg-white shadow-sm text-blue-600 ring-1 ring-black/5">Full Day</button>
          <button type="button" onclick="selectDur(this,'Morning')" class="dur-btn flex-1 py-2.5 text-sm font-semibold text-slate-500">Morning</button>
          <button type="button" onclick="selectDur(this,'Afternoon')" class="dur-btn flex-1 py-2.5 text-sm font-semibold text-slate-500">Afternoon</button>
        </div>
        <input type="hidden" id="durationValue" value="Full Day" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-extrabold text-slate-700 ml-1">Reason <span class="text-red-500">*</span></label>
        <textarea id="reason" rows="3" class="input resize-none" placeholder="Please specify your reason..." oninput="validateOnFly()"></textarea>
      </div>

      <div class="card bg-amber-50 border border-amber-100">
        <div class="text-sm font-extrabold text-amber-700">Attachment</div>
        <div class="text-[12px] text-amber-700/80 mt-1 font-semibold">
          ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Draft (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Sick ‚â• 3 ‡∏ß‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ö‡∏Å‡πà‡∏≠‡∏ô Submit)
        </div>
      </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-slate-200 p-5 pb-[calc(1.25rem+env(safe-area-inset-bottom))]">
      <button id="submitBtn" onclick="handleSubmit()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-2xl font-extrabold text-lg shadow-lg shadow-blue-500/25 active:scale-[0.98] transition">
        Send Draft
      </button>
    </div>
  </div>

  <div id="loader" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center max-w-[170px]">
      <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin mb-3"></div>
      <div class="font-extrabold text-slate-700 text-sm" id="loaderText">Processing‚Ä¶</div>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const LIFF_ID = "2008997153-n5oIYKUP";
  const API_URL = "https://script.google.com/macros/s/AKfycbzDaipJG7WIM8Qp-PhnVEpACZsXM86Q_dYWgxAVM3wWg-VtPp4LocgI2zbYquIFO7WW/exec";
  const DRAFT_PREFIX = "LEAVE_DRAFT:";
  // ==================

  const $ = (id) => document.getElementById(id);

  let userProfile = null;
  let companyHolidays = [];
  let leaveBalances = {};
  let editingRequestId = "";

  function showLoader(msg){ $("loaderText").textContent = msg || "Processing‚Ä¶"; $("loader").classList.remove("hidden"); $("loader").classList.add("flex"); }
  function hideLoader(){ $("loader").classList.add("hidden"); $("loader").classList.remove("flex"); }

  // ‚úÖ KEY FIX: no preflight POST helper
  async function apiPost(action, payloadObj) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" }, // ‚úÖ avoid OPTIONS
      body: JSON.stringify({ action, ...payloadObj })
    });
    const data = await res.json();
    return data;
  }

  function selectType(btn, val) {
    document.querySelectorAll(".type-btn").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    $("leaveTypeValue").value = val;

    if (val === "Other") $("otherField").classList.remove("hidden");
    else { $("otherField").classList.add("hidden"); $("otherSpecify").value = ""; }

    updateRemainingUI();
    validateOnFly();
  }

  function selectDur(btn, val) {
    document.querySelectorAll(".dur-btn").forEach(b => {
      b.className = "dur-btn flex-1 py-2.5 text-sm font-semibold text-slate-500";
      b.disabled = false;
    });
    btn.className = "dur-btn flex-1 py-2.5 text-sm font-extrabold rounded-lg bg-white shadow-sm text-blue-600 ring-1 ring-black/5";
    $("durationValue").value = val;
    validateOnFly();
  }

  async function fetchHolidays() {
    try {
      const res = await fetch(API_URL + "?action=get_holidays&t=" + Date.now());
      const data = await res.json();
      companyHolidays = Array.isArray(data) ? data : [];
    } catch(e) { companyHolidays = []; }
  }

  async function fetchLeaveBalance(userId) {
    try {
      const res = await fetch(API_URL + "?action=get_balance&userId=" + encodeURIComponent(userId) + "&t=" + Date.now());
      const data = await res.json();
      leaveBalances = {};
      if (data && data.ok && Array.isArray(data.balances)) {
        data.balances.forEach(b => {
          if (!b || !b.type) return;
          const r = Number(b.remaining);
          leaveBalances[String(b.type)] = isNaN(r) ? 0 : r;
        });
      }
    } catch(e) { leaveBalances = {}; }
    updateRemainingUI();
  }

  function updateRemainingUI() {
    const type = $("leaveTypeValue").value;
    const box = $("remainingBox");
    const valEl = $("remainingValue");
    if (!type || leaveBalances[type] == null) { box.classList.add("hidden"); return; }
    const rem = leaveBalances[type];
    valEl.textContent = `${rem} ${(rem === 1) ? "Day" : "Days"}`;
    box.classList.remove("hidden");
  }

  function calcWorkingDays(sStr, eStr) {
    if (!sStr || !eStr) return 0;
    const s = new Date(sStr);
    const e = new Date(eStr);
    if (isNaN(s.getTime()) || isNaN(e.getTime()) || s > e) return 0;

    let total = 0;
    const cur = new Date(s);
    while (cur <= e) {
      const dow = cur.getDay();
      const isWeekend = (dow === 0 || dow === 6);
      const dateStr = cur.toISOString().split("T")[0];
      const isHoliday = Array.isArray(companyHolidays) && companyHolidays.includes(dateStr);
      if (!isWeekend && !isHoliday) total++;
      cur.setDate(cur.getDate() + 1);
    }
    const dp = $("durationValue").value || "Full Day";
    if ((dp === "Morning" || dp === "Afternoon") && total > 0) total -= 0.5;
    return total;
  }

  function validateOnFly() {
    const s = $("startDate").value;
    const e = $("endDate").value;
    const badge = $("dayBadge");

    $("startDate").classList.remove("err");
    $("endDate").classList.remove("err");
    $("reason").classList.remove("err");

    if (!s || !e) { badge.classList.add("hidden"); return true; }
    const days = calcWorkingDays(s, e);
    badge.textContent = `Working: ${days} ${(days === 1) ? "Day" : "Days"}`;
    badge.classList.remove("hidden");
    return true;
  }

  function setTypeUI(typeVal) {
    const type = String(typeVal || "").trim();
    if (!type) return;
    document.querySelectorAll(".type-btn").forEach(b => {
      // match by onclick value
      const onclick = b.getAttribute("onclick") || "";
      if (onclick.includes(`'${type}'`)) b.classList.add("selected");
      else b.classList.remove("selected");
    });
    $("leaveTypeValue").value = type;
    if (type === "Other") $("otherField").classList.remove("hidden");
    else $("otherField").classList.add("hidden");
    updateRemainingUI();
  }

  async function loadRequestIfEdit() {
    const params = new URLSearchParams(location.search);
    const rid = params.get("requestId");
    if (!rid) return;
    editingRequestId = rid;

    showLoader("Loading draft‚Ä¶");
    try {
      const res = await fetch(API_URL + "?action=get_request&requestId=" + encodeURIComponent(rid) + "&t=" + Date.now());
      const data = await res.json();
      if (data && data.ok && data.request) {
        const r = data.request;

        // IMPORTANT: these keys must match your sheet headers
        setTypeUI(r["LeaveType"]);
        $("otherSpecify").value = r["OtherSpecify"] || "";
        $("startDate").value = r["StartDate"] || $("startDate").value;
        $("endDate").value = r["EndDate"] || $("endDate").value;

        const dp = r["DayPart"] || "Full Day";
        const btns = document.querySelectorAll(".dur-btn");
        if (dp === "Morning") selectDur(btns[1], "Morning");
        else if (dp === "Afternoon") selectDur(btns[2], "Afternoon");
        else selectDur(btns[0], "Full Day");

        $("reason").value = r["Reason"] || "";
        validateOnFly();
      }
    } catch(e) {}
    hideLoader();
  }

  async function handleSubmit() {
    const type = $("leaveTypeValue").value;
    const other = $("otherSpecify").value.trim();
    const startDate = $("startDate").value;
    const endDate = $("endDate").value;
    const reason = $("reason").value.trim();
    const dayPart = $("durationValue").value || "Full Day";

    if (!type) return alert("Please select Leave Type");
    if (type === "Other" && !other) return alert("Please specify Other type");
    if (!startDate || !endDate) return alert("Please select dates");
    if (!reason) { $("reason").classList.add("err"); return alert("Please specify reason"); }

    const leaveDays = calcWorkingDays(startDate, endDate);

    showLoader("Saving draft‚Ä¶");
    const btn = $("submitBtn");
    btn.disabled = true;
    btn.classList.add("opacity-70");

    try {
      const payload = {
        requestId: editingRequestId || "",
        userId: userProfile?.userId || "",
        name: userProfile?.displayName || "",
        leaveType: type,
        otherSpecify: other,
        startDate,
        endDate,
        dayPart,
        reason,
        leaveDays
      };

      // ‚úÖ KEY FIX: POST as text/plain + action in body
      const data = await apiPost("save_draft", payload);

      if (!data || !data.ok || !data.requestId) throw new Error(data?.error || "save_draft_failed");

      // Send draft signal to chat (WebhookHub will pick this up)
      await liff.sendMessages([{ type:"text", text: DRAFT_PREFIX + data.requestId }]);

      hideLoader();
      try { liff.closeWindow(); } catch(e) { alert("Saved draft. Please close this page."); }

    } catch(err) {
      hideLoader();
      btn.disabled = false;
      btn.classList.remove("opacity-70");
      alert("Error: " + (err.message || err));
    }
  }

  async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    userProfile = await liff.getProfile();
    $("userGreet").innerHTML = `Hi, <span class="font-extrabold text-slate-800">${userProfile.displayName}</span>`;

    if (userProfile.pictureUrl) {
      $("profileImg").src = userProfile.pictureUrl;
      $("avatarBox").classList.remove("hidden");
    }

    const today = new Date().toISOString().split("T")[0];
    $("startDate").value = today;
    $("endDate").value = today;
    $("startDate").setAttribute("min", today);
    $("endDate").setAttribute("min", today);

    await fetchLeaveBalance(userProfile.userId);
    await fetchHolidays();
    await loadRequestIfEdit();
    validateOnFly();
  }

  init().catch(err => alert("LIFF init error: " + (err.message || err)));
</script>
</body>
</html>
